!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("xgplayer")):"function"==typeof define&&define.amd?define(["xgplayer"],t):(e=e||self).FlvPlayer=t(e.Player)}(this,(function(e){"use strict";e=e&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e;var t={VISIBILITY_CHANGE:"VISIBILITY_CHANGE"},i={SEEK:"SEEK"},n={LADER_START:"LOADER_START",LOADER_DATALOADED:"LOADER_DATALOADED",LOADER_COMPLETE:"LOADER_COMPLETE",LOADER_RESPONSE_HEADERS:"LOADER_RESPONSE_HEADERS",LOADER_ERROR:"LOADER_ERROR",LOADER_RETRY:"LOADER_RETRY",LOADER_TTFB:"LOADER_TTFB"},r={DEMUX_START:"DEMUX_START",DEMUX_COMPLETE:"DEMUX_COMPLETE",DEMUX_ERROR:"DEMUX_ERROR",METADATA_PARSED:"METADATA_PARSED",SEI_PARSED:"SEI_PARSED",VIDEO_METADATA_CHANGE:"VIDEO_METADATA_CHANGE",AUDIO_METADATA_CHANGE:"AUDIO_METADATA_CHANGE",MEDIA_INFO:"MEDIA_INFO",ISKEYFRAME:"ISKEYFRAME"},a={REMUX_METADATA:"REMUX_METADATA",REMUX_MEDIA:"REMUX_MEDIA",MEDIA_SEGMENT:"MEDIA_SEGMENT",REMUX_ERROR:"REMUX_ERROR",INIT_SEGMENT:"INIT_SEGMENT",DETECT_CHANGE_STREAM:"DETECT_CHANGE_STREAM",DETECT_CHANGE_STREAM_DISCONTINUE:"DETECT_CHANGE_STREAM_DISCONTINUE",DETECT_AUDIO_GAP:"DETECT_AUDIO_GAP",DETECT_LARGE_GAP:"DETECT_LARGE_GAP",DETECT_AUDIO_OVERLAP:"DETECT_AUDIO_OVERLAP",RANDOM_ACCESS_POINT:"RANDOM_ACCESS_POINT",DETECT_FRAG_ID_DISCONTINUE:"DETECT_FRAG_ID_DISCONTINUE"},o={SOURCE_UPDATE_END:"SOURCE_UPDATE_END",MSE_ERROR:"MSE_ERROR",MSE_WRONG_TRACK_ADD:"MSE_WRONG_TRACK_ADD"},s={RETRY_TIME_EXCEEDED:"RETRY_TIME_EXCEEDED"},u=Object.assign({},n,r,a,o,s,i,t),l=[],c=[];for(var h in u)u.hasOwnProperty(h)&&l.push(u[h]);for(var f in u)u.hasOwnProperty(f)&&c.push(u[f]);var d={ALLEVENTS:u,HLS_EVENTS:s,REMUX_EVENTS:a,DEMUX_EVENTS:r,MSE_EVENTS:o,LOADER_EVENTS:n,FlvAllowedEvents:l,HlsAllowedEvents:c,CRYPTO_EVENTS:{START_DECRYPTOO:"START_DECRYPTO",DECRYPTED:"DECRYPTED"},PLAYER_EVENTS:i,BROWSER_EVENTS:t},p=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();function v(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var y=function e(){v(this,e),this.mimetype="",this.init=null,this.data=[],this.bufferDuration=0},_=function(){function e(){v(this,e),this.sources={}}return p(e,[{key:"getSource",value:function(e){return this.sources[e]}},{key:"createSource",value:function(e){return this.sources[e]=new y,this.sources[e]}},{key:"clear",value:function(){this.sources={}}},{key:"destroy",value:function(){this.clear()}}]),e}(),m=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();var g=function(){function e(t){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!(t instanceof ArrayBuffer))throw new Error("data is invalid");this.buffer=t,this.dataview=new DataView(t),this.dataview.position=0}return m(e,[{key:"back",value:function(e){this.position-=e}},{key:"getUint8",value:function(e){return this.dataview.getUint8(e)}},{key:"skip",value:function(t){for(var i=Math.floor(t/4),n=t%4,r=0;r<i;r++)e.readByte(this.dataview,4);n>0&&e.readByte(this.dataview,n)}},{key:"readUint8",value:function(){return e.readByte(this.dataview,1)}},{key:"readUint16",value:function(){return e.readByte(this.dataview,2)}},{key:"readUint24",value:function(){return e.readByte(this.dataview,3)}},{key:"readUint32",value:function(){return e.readByte(this.dataview,4)}},{key:"readUint64",value:function(){return e.readByte(this.dataview,8)}},{key:"readInt8",value:function(){return e.readByte(this.dataview,1,!0)}},{key:"readInt16",value:function(){return e.readByte(this.dataview,2,!0)}},{key:"readInt32",value:function(){return e.readByte(this.dataview,4,!0)}},{key:"writeUint32",value:function(e){return new Uint8Array([e>>>24&255,e>>>16&255,e>>>8&255,255&e])}},{key:"length",get:function(){return this.buffer.byteLength}},{key:"position",set:function(e){this.dataview.position=e},get:function(){return this.dataview.position}}],[{key:"readByte",value:function(e,t,i){var n=void 0;switch(t){case 1:n=i?e.getInt8(e.position):e.getUint8(e.position);break;case 2:n=i?e.getInt16(e.position):e.getUint16(e.position);break;case 3:if(i)throw new Error("not supported for readByte 3");n=e.getUint8(e.position)<<16,n|=e.getUint8(e.position+1)<<8,n|=e.getUint8(e.position+2);break;case 4:n=i?e.getInt32(e.position):e.getUint32(e.position);break;case 8:if(i)throw new Error("not supported for readBody 8");n=e.getUint32(e.position)<<32,n|=e.getUint32(e.position+4);break;default:n=""}return e.position+=t,n}}]),e}(),E="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},b=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();function k(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==(void 0===t?"undefined":E(t))&&"function"!=typeof t?e:t}function A(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":E(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function S(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var T=function(){function e(){S(this,e),this.id=-1,this.sequenceNumber=0,this.samples=[],this.droppedSamples=[],this.length=0}return b(e,[{key:"reset",value:function(){this.sequenceNumber=0,this.samples=[],this.length=0}},{key:"destroy",value:function(){this.reset(),this.id=-1}}]),e}(),D=function(e){function t(){S(this,t);var e=k(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.TAG="AudioTrack",e.type="audio",e}return A(t,e),t}(T),w=function(e){function t(){S(this,t);var e=k(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.TAG="VideoTrack",e.type="video",e.dropped=0,e.sequenceNumber=0,e}return A(t,e),b(t,[{key:"reset",value:function(){this.sequenceNumber=0,this.samples=[],this.length=0,this.dropped=0}}]),t}(T),R=(function(){function e(){S(this,e),this.audioTrack=null,this.videoTrack=null}b(e,[{key:"destroy",value:function(){this.audioTrack=null,this.videoTrack=null}}])}(),function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}());var O=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.length=t||0,this.historyLen=t||0,this.array=[],this.offset=0}return R(e,[{key:"push",value:function(e){this.array.push(e),this.length+=e.byteLength,this.historyLen+=e.byteLength}},{key:"shift",value:function(e){if(this.array.length<1)return new Uint8Array(0);if(void 0===e)return this._shiftBuffer();if(this.offset+e===this.array[0].length){var t=this.array[0].slice(this.offset,this.offset+e);return this.offset=0,this.array.shift(),this.length-=e,t}if(this.offset+e<this.array[0].length){var i=this.array[0].slice(this.offset,this.offset+e);return this.offset+=e,this.length-=e,i}for(var n=new Uint8Array(e),r=0;this.array.length>0&&e>0;){if(this.offset+e<this.array[0].length){var a=this.array[0].slice(this.offset,this.offset+e);n.set(a,r),this.offset+=e,this.length-=e,e=0;break}var o=this.array[0].length-this.offset;n.set(this.array[0].slice(this.offset,this.array[0].length),r),this.array.shift(),this.offset=0,r+=o,this.length-=o,e-=o}return n}},{key:"clear",value:function(){this.array=[],this.length=0,this.offset=0}},{key:"destroy",value:function(){this.clear(),this.historyLen=0}},{key:"_shiftBuffer",value:function(){return this.length-=this.array[0].length,this.offset=0,this.array.shift()}},{key:"toInt",value:function(e,t){for(var i=0,n=this.offset+e;n<this.offset+t+e;)n<this.array[0].length?i=256*i+this.array[0][n]:this.array[1]&&(i=256*i+this.array[1][n-this.array[0].length]),n++;return i}}]),e}(),L=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();function x(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var B=function(){function e(t){x(this,e);var i={sampleRate:48e3,channelCount:2,codec:"mp4a.40.2",config:[41,401,136,0],duration:0,id:2,refSampleDuration:21,sampleRateIndex:3,timescale:1e3,type:"audio"};return t?Object.assign({},i,t):i}return L(e,[{key:"destroy",value:function(){this.init=null}}]),e}(),P=function(){function e(t){x(this,e);var i={avcc:null,sps:new Uint8Array(0),pps:new Uint8Array(0),chromaFormat:420,codec:"avc1.640020",codecHeight:720,codecWidth:1280,duration:0,frameRate:{fixed:!0,fps:25,fps_num:25e3,fps_den:1e3},id:1,level:"3.2",presentHeight:720,presentWidth:1280,profile:"High",refSampleDuration:40,parRatio:{height:1,width:1},timescale:1e3,type:"video"};return t?Object.assign({},i,t):i}return L(e,[{key:"destroy",value:function(){this.init=null,this.sps=null,this.pps=null}}]),e}(),C=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();function M(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}!function(){function e(t){M(this,e);var i=e.getDefault();return t?Object.assign({},i,t):i}C(e,null,[{key:"getDefault",value:function(){return{dts:-1,pts:-1,originDts:-1,data:new Uint8Array}}}])}();var I=function(){function e(t){M(this,e);var i=e.getDefault();return t?Object.assign({},i,t):i}return C(e,null,[{key:"getDefault",value:function(){return{dts:-1,pts:void 0,isKeyframe:!1,originDts:-1,data:new Uint8Array,nals:[]}}}]),e}(),U=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();var V=function(e){for(var t in e)if(e.hasOwnProperty(t)&&null===e[t])return!1;return!0},N=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.mimeType=null,this.duration=null,this.hasVideo=!1,this.video={codec:null,width:null,height:null,profile:null,level:null,frameRate:{fixed:!0,fps:25,fps_num:25e3,fps_den:1e3},chromaFormat:null,parRatio:{width:1,height:1}},this.hasAudio=!1,this.audio={codec:null,sampleRate:null,sampleRateIndex:null,channelCount:null}}return U(e,[{key:"isComplete",value:function(){return e.isBaseInfoReady(this)&&e.isVideoReady(this)&&e.isAudioReady(this)}}],[{key:"isBaseInfoReady",value:function(e){return V(e)}},{key:"isVideoReady",value:function(e){return!e.hasVideo||V(e.video)}},{key:"isAudioReady",value:function(e){return!e.hasAudio||V(e.video)}}]),e}();var G=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.filtered=-1,this.tagType=-1,this.datasize=-1,this.dts=-1};function F(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function j(e,t){return e(t={exports:{}},t.exports),t.exports}var H=j((function(e){var t=Object.prototype.hasOwnProperty,i="~";function n(){}function r(e,t,i){this.fn=e,this.context=t,this.once=i||!1}function a(e,t,n,a,o){if("function"!=typeof n)throw new TypeError("The listener must be a function");var s=new r(n,a||e,o),u=i?i+t:t;return e._events[u]?e._events[u].fn?e._events[u]=[e._events[u],s]:e._events[u].push(s):(e._events[u]=s,e._eventsCount++),e}function o(e,t){0==--e._eventsCount?e._events=new n:delete e._events[t]}function s(){this._events=new n,this._eventsCount=0}Object.create&&(n.prototype=Object.create(null),(new n).__proto__||(i=!1)),s.prototype.eventNames=function(){var e,n,r=[];if(0===this._eventsCount)return r;for(n in e=this._events)t.call(e,n)&&r.push(i?n.slice(1):n);return Object.getOwnPropertySymbols?r.concat(Object.getOwnPropertySymbols(e)):r},s.prototype.listeners=function(e){var t=i?i+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var r=0,a=n.length,o=new Array(a);r<a;r++)o[r]=n[r].fn;return o},s.prototype.listenerCount=function(e){var t=i?i+e:e,n=this._events[t];return n?n.fn?1:n.length:0},s.prototype.emit=function(e,t,n,r,a,o){var s=i?i+e:e;if(!this._events[s])return!1;var u,l,c=this._events[s],h=arguments.length;if(c.fn){switch(c.once&&this.removeListener(e,c.fn,void 0,!0),h){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,t),!0;case 3:return c.fn.call(c.context,t,n),!0;case 4:return c.fn.call(c.context,t,n,r),!0;case 5:return c.fn.call(c.context,t,n,r,a),!0;case 6:return c.fn.call(c.context,t,n,r,a,o),!0}for(l=1,u=new Array(h-1);l<h;l++)u[l-1]=arguments[l];c.fn.apply(c.context,u)}else{var f,d=c.length;for(l=0;l<d;l++)switch(c[l].once&&this.removeListener(e,c[l].fn,void 0,!0),h){case 1:c[l].fn.call(c[l].context);break;case 2:c[l].fn.call(c[l].context,t);break;case 3:c[l].fn.call(c[l].context,t,n);break;case 4:c[l].fn.call(c[l].context,t,n,r);break;default:if(!u)for(f=1,u=new Array(h-1);f<h;f++)u[f-1]=arguments[f];c[l].fn.apply(c[l].context,u)}}return!0},s.prototype.on=function(e,t,i){return a(this,e,t,i,!1)},s.prototype.once=function(e,t,i){return a(this,e,t,i,!0)},s.prototype.removeListener=function(e,t,n,r){var a=i?i+e:e;if(!this._events[a])return this;if(!t)return o(this,a),this;var s=this._events[a];if(s.fn)s.fn!==t||r&&!s.once||n&&s.context!==n||o(this,a);else{for(var u=0,l=[],c=s.length;u<c;u++)(s[u].fn!==t||r&&!s[u].once||n&&s[u].context!==n)&&l.push(s[u]);l.length?this._events[a]=1===l.length?l[0]:l:o(this,a)}return this},s.prototype.removeAllListeners=function(e){var t;return e?(t=i?i+e:e,this._events[t]&&o(this,t)):(this._events=new n,this._eventsCount=0),this},s.prototype.off=s.prototype.removeListener,s.prototype.addListener=s.prototype.on,s.prefixed=i,s.EventEmitter=s,e.exports=s})),z="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},X=function e(t,i,n){null===t&&(t=Function.prototype);var r=Object.getOwnPropertyDescriptor(t,i);if(void 0===r){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,i,n)}if("value"in r)return r.value;var o=r.get;return void 0!==o?o.call(n):void 0},W=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();function K(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var Y="__TO__",q=function(){function e(t,i){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];K(this,e),this._emitter=new H,this._emitter.off||(this._emitter.off=this._emitter.removeListener),this.mediaInfo=new N,this._instanceMap={},this._clsMap={},this._inited=!1,this.allowedEvents=n,this._configs=i,this._player=t,this._hooks={}}return W(e,[{key:"getInstance",value:function(e){var t=this._instanceMap[e];return t||null}},{key:"initInstance",value:function(e){for(var t=arguments.length,i=Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];var r=i[0],a=i[1],o=i[2],s=i[3];if(this._clsMap[e]){var u=new this._clsMap[e](r,a,o,s);return this._instanceMap[e]=u,u.init&&u.init(),u}throw new Error(e+"未在context中注册")}},{key:"init",value:function(e){if(!this._inited){for(var t in this._clsMap)this._clsMap.hasOwnProperty(t)&&!this._instanceMap[t]&&this.initInstance(t,e);this._inited=!0}}},{key:"registry",value:function(e,t){var i=this,n=this._emitter,r=this._isMessageNameValid.bind(this),a=this,o=function(t){function i(t,n,r){K(this,i);var o=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==(void 0===t?"undefined":z(t))&&"function"!=typeof t?e:t}(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,t,n,r));return o.listeners={},o.onceListeners={},o.TAG=e,o._context=a,o}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":z(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(i,t),W(i,[{key:"on",value:function(t,i){return r(t),this.listeners[t]?this.listeners[t].push(i):this.listeners[t]=[i],n.on(""+t+Y+e,i),n.on(t,i)}},{key:"before",value:function(e,t){r(e),a._hooks[e]?a._hooks[e].push(t):a._hooks[e]=[t]}},{key:"once",value:function(t,i){return r(t),this.onceListeners[t]?this.onceListeners[t].push(i):this.onceListeners[t]=[i],n.once(""+t+Y+e,i),n.once(t,i)}},{key:"emit",value:function(e){r(e);for(var t=a._hooks?a._hooks[e]:null,i=arguments.length,o=Array(i>1?i-1:0),s=1;s<i;s++)o[s-1]=arguments[s];if(t)for(var u=0,l=t.length;u<l;u++){var c=t[u];c.apply(void 0,o)}return n.emit.apply(n,[e].concat(o))}},{key:"emitTo",value:function(e,t){r(t);for(var i=arguments.length,a=Array(i>2?i-2:0),o=2;o<i;o++)a[o-2]=arguments[o];return n.emit.apply(n,[""+t+Y+e].concat(a))}},{key:"off",value:function(e,t){return r(e),n.off(e,t)}},{key:"removeListeners",value:function(){var t=Object.prototype.hasOwnProperty.bind(this.listeners);for(var i in this.listeners)if(t(i))for(var r=this.listeners[i]||[],a=0;a<r.length;a++){var o=r[a];n.off(i,o),n.off(""+i+Y+e,o)}for(var s in this.onceListeners)if(t(s))for(var u=this.onceListeners[s]||[],l=0;l<u.length;l++){var c=u[l];n.off(s,c),n.off(""+s+Y+e,c)}}},{key:"destroy",value:function(){if(this.removeListeners(),this.listeners={},delete a._instanceMap[e],X(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"destroy",this))return X(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"destroy",this).call(this);this._context=null}},{key:"_player",get:function(){return this._context?this._context._player:null},set:function(e){this._context&&(this._context._player=e)}},{key:"_pluginConfig",get:function(){return this._context?this._context._configs:null}}]),i}(t);return this._clsMap[e]=o,function(){for(var t=arguments.length,n=Array(t),r=0;r<t;r++)n[r]=arguments[r];return i.initInstance.apply(i,[e].concat(n))}}},{key:"seek",value:function(e){this._emitter.emit(d.PLAYER_EVENTS.SEEK,e)}},{key:"destroyInstances",value:function(){var e=this;Object.keys(this._instanceMap).forEach((function(t){e._instanceMap[t].destroy&&e._instanceMap[t].destroy()}))}},{key:"destroy",value:function(){this.destroyInstances(),this._emitter&&this._emitter.removeAllListeners(),this._emitter=null,this.allowedEvents=[],this._clsMap=null,this._hooks=null,this._player=null,this._configs=null}},{key:"_isMessageNameValid",value:function(e){if(!this.allowedEvents.indexOf(e)<0)throw new Error("unregistered message name: "+e)}}]),e}(),Z=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();var J,Q=d.MSE_EVENTS,$=function(){function e(t,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),i&&(this._context=i,this.emit=i._emitter.emit.bind(i._emitter)),this.TAG="MSE",this.configs=Object.assign({},t),this.container=this.configs.container,this.format=this.configs.format,this.mediaSource=null,this.sourceBuffers={},this.preloadTime=this.configs.preloadTime||1,this.onSourceOpen=this.onSourceOpen.bind(this),this.onTimeUpdate=this.onTimeUpdate.bind(this),this.onUpdateEnd=this.onUpdateEnd.bind(this),this.onWaiting=this.onWaiting.bind(this),this.opened=!1}return Z(e,[{key:"init",value:function(){this.mediaSource=new self.MediaSource,this.mediaSource.addEventListener("sourceopen",this.onSourceOpen),this._url=null,this.container.addEventListener("timeupdate",this.onTimeUpdate),this.container.addEventListener("waiting",this.onWaiting)}},{key:"resetContext",value:function(t,i){if(this._context=t,this.emit=t._emitter.emit.bind(t._emitter),!i)for(var n=0;n<Object.keys(this.sourceBuffers).length;n++){var r=this.sourceBuffers[Object.keys(this.sourceBuffers)[n]];r.updating||e.clearBuffer(r)}}},{key:"onTimeUpdate",value:function(){this.emit("TIME_UPDATE",this.container)}},{key:"onWaiting",value:function(){this.emit("WAITING",this.container)}},{key:"onSourceOpen",value:function(){this.opened=!0,this.addSourceBuffers()}},{key:"onUpdateEnd",value:function(){this.emit(Q.SOURCE_UPDATE_END),this.doAppend()}},{key:"addSourceBuffers",value:function(){if(this.mediaSource&&"open"===this.mediaSource.readyState&&this.opened){var e=this._context.getInstance("PRE_SOURCE_BUFFER"),t=this._context.getInstance("TRACKS"),i=void 0;if(e&&t){e=e.sources;for(var n=!1,r=0,a=Object.keys(e).length;r<a;r++){var o=Object.keys(e)[r];n=!1,"audio"===o?i=t.audioTrack:"video"===o&&(i=t.videoTrack),i&&null!==e[o].init&&e[o].data.length&&(n=!0)}if(n){if(Object.keys(this.sourceBuffers).length>1)return;for(var s=0,u=Object.keys(e).length;s<u;s++){var l=Object.keys(e)[s];if(!this.sourceBuffers[l]){var c=e[l],h="video"===l?"video/mp4;codecs="+c.mimetype:"audio/mp4;codecs="+c.mimetype;try{var f=this.mediaSource.addSourceBuffer(h);this.sourceBuffers[l]=f,f.addEventListener("updateend",this.onUpdateEnd)}catch(e){if(22===e.code&&Object.keys(this.sourceBuffers).length>0)return this.emit(Q.MSE_WRONG_TRACK_ADD,l);this.emit(Q.MSE_ERROR,this.TAG,new Error(e.message))}}}Object.keys(this.sourceBuffers).length===this.sourceBufferLen&&this.doAppend()}}}}},{key:"doAppend",value:function(){if(this.mediaSource&&"closed"!==this.mediaSource.readyState){try{this._doCleanupSourceBuffer()}catch(e){}var e=this._context.getInstance("PRE_SOURCE_BUFFER");if(e&&!(Object.keys(this.sourceBuffers).length<this.sourceBufferLen))for(var t=0;t<Object.keys(this.sourceBuffers).length;t++){var i=Object.keys(this.sourceBuffers)[t],n=this.sourceBuffers[i];if(!n.updating){var r=e.sources[i];if(this["no"+i])r.data=[],r.init.buffer=null;else if(r&&!r.inited)try{n.appendBuffer(r.init.buffer.buffer),r.inited=!0}catch(e){}else if(r){var a=r.data.shift();if(a)try{n.appendBuffer(a.buffer.buffer)}catch(e){r.data.unshift(a)}}}}}}},{key:"endOfStream",value:function(){try{"open"===this.mediaSource.readyState&&this.mediaSource.endOfStream()}catch(e){}}},{key:"remove",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;try{for(var i=0;i<Object.keys(this.sourceBuffers).length;i++){var n=this.sourceBuffers[Object.keys(this.sourceBuffers)[i]];n.updating||e>t&&n.remove(t,e)}}catch(e){}}},{key:"_doCleanupSourceBuffer",value:function(){for(var e=this.container.currentTime,t={video:[],audio:[]},i=0;i<Object.keys(this.sourceBuffers).length;i++){for(var n=Object.keys(this.sourceBuffers)[i],r=this.sourceBuffers[n],a=r.buffered,o=!1,s=0;s<a.length;s++){var u=a.start(s),l=a.end(s);if(u<=e&&e<l+3){if(e-u>=180){o=!0;var c=e-180;t[n].push({start:u,end:c})}}else l<e&&e-u>=180&&(o=!0,t[n].push({start:u,end:l}))}o&&!r.updating&&this._doRemoveRanges(t)}}},{key:"_doRemoveRanges",value:function(e){for(var t in e)if(this.sourceBuffers[t]&&!this.sourceBuffers[t].updating)for(var i=this.sourceBuffers[t],n=e[t];n.length&&!i.updating;){var r=n.shift();try{r&&r.end>r.start&&i.remove(r.start,r.end)}catch(e){}}}},{key:"cleanBuffers",value:function(){for(var t=this,i=[],n=function(n){var r=t.sourceBuffers[Object.keys(t.sourceBuffers)[n]],a=void 0;a=r.updating?new Promise((function(t){r.addEventListener("updateend",(function i(){var n=3;setTimeout((function i(){r.updating?n>0?(setTimeout(i,200),n--):t():(e.clearBuffer(r),r.addEventListener("updateend",(function(){t()})))}),200),r.removeEventListener("updateend",i)}))})):new Promise((function(t){e.clearBuffer(r),r.addEventListener("updateend",(function(){t()}))})),i.push(a)},r=0;r<Object.keys(this.sourceBuffers).length;r++)n(r);return Promise.all(i)}},{key:"removeBuffers",value:function(){for(var t=this,i=[],n=function(n){var r=t.sourceBuffers[Object.keys(t.sourceBuffers)[n]];r.removeEventListener("updateend",t.onUpdateEnd);var a=void 0;a=r.updating?new Promise((function(t){r.addEventListener("updateend",(function i(){var n=3;setTimeout((function i(){r.updating?n>0?(setTimeout(i,200),n--):t():(e.clearBuffer(r),r.addEventListener("updateend",(function(){t()})))}),200),r.removeEventListener("updateend",i)}))})):new Promise((function(t){e.clearBuffer(r),r.addEventListener("updateend",(function(){t()}))})),i.push(a)},r=0;r<Object.keys(this.sourceBuffers).length;r++)n(r);return Promise.all(i)}},{key:"destroy",value:function(){var e=this;return this.container?(this.container.removeEventListener("timeupdate",this.onTimeUpdate),this.container.removeEventListener("waiting",this.onWaiting),this.mediaSource.removeEventListener("sourceopen",this.onSourceOpen),this.removeBuffers().then((function(){for(var t=Object.keys(e.sourceBuffers),i=0;i<t.length;i++){var n=e.sourceBuffers[t[i]];delete e.sourceBuffers[t[i]],"open"===e.mediaSource.readyState&&e.mediaSource.removeSourceBuffer(n)}e.endOfStream();try{window.URL.revokeObjectURL(e.url)}catch(e){}e.url=null,e.configs={},e.container=null,e.mediaSource=null,e.sourceBuffers={},e.preloadTime=1,e.onSourceOpen=null,e.onTimeUpdate=null,e.onUpdateEnd=null,e.onWaiting=null,e.noaudio=void 0,e.novideo=void 0}))):Promise.resolve()}},{key:"sourceBufferLen",get:function(){return this._context.mediaInfo?(!!this._context.mediaInfo.hasVideo&&!this.novideo)+(!!this._context.mediaInfo.hasAudio&&!this.noaudio):this.noaudio||this.novideo?1:2}},{key:"url",set:function(e){this._url=e},get:function(){if(!this._url)try{this._url=window.URL.createObjectURL(this.mediaSource)}catch(e){}return this._url}}],[{key:"clearBuffer",value:function(e){try{for(var t=e.buffered,i=.1,n=0,r=t.length;n<r;n++)i=t.end(n);e.remove(0,i)}catch(e){}}}]),e}(),ee=(J=new ArrayBuffer(2),new DataView(J).setInt16(0,256,!0),256===new Int16Array(J)[0]),te={get device(){var e=te.os;return e.isPc?"pc":e.isTablet?"tablet":"mobile"},get browser(){var e=navigator.userAgent.toLowerCase(),t={ie:/rv:([\d.]+)\) like gecko/,firfox:/firefox\/([\d.]+)/,chrome:/chrome\/([\d.]+)/,opera:/opera.([\d.]+)/,safari:/version\/([\d.]+).*safari/};return[].concat(Object.keys(t).filter((function(i){return t[i].test(e)})))[0]},get os(){var e=navigator.userAgent,t=/(?:Windows Phone)/.test(e),i=/(?:SymbianOS)/.test(e)||t,n=/(?:Android)/.test(e),r=/(?:Firefox)/.test(e),a=/(?:iPad|PlayBook)/.test(e)||n&&!/(?:Mobile)/.test(e)||r&&/(?:Tablet)/.test(e),o=/(?:iPhone)/.test(e)&&!a;return{isTablet:a,isPhone:o,isAndroid:n,isPc:!o&&!n&&!i,isSymbian:i,isWindowsPhone:t,isFireFox:r}},get isLe(){return ee}},ie=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();var ne=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._firstCheckpoint=0,this._lastCheckpoint=0,this._intervalBytes=0,this._lastSamplingBytes=0,this._now=Date.now}return ie(e,[{key:"reset",value:function(){this._firstCheckpoint=this._lastCheckpoint=0,this._intervalBytes=0,this._lastSamplingBytes=0}},{key:"addBytes",value:function(e){var t=this._now()-this._lastCheckpoint;0===this._firstCheckpoint?(this._firstCheckpoint=this._now(),this._lastCheckpoint=this._firstCheckpoint,this._intervalBytes+=e):t<5e3?this._intervalBytes+=e:(this._lastSamplingBytes=this._intervalBytes/(t/1e3),this._intervalBytes=e,this._lastCheckpoint=this._now())}},{key:"currentKBps",get:function(){this.addBytes(0);var e=(this._now()-this._lastCheckpoint)/1e3;return 0===e&&(e=1),this._intervalBytes/e/1024}},{key:"lastSamplingKBps",get:function(){return this.addBytes(0),0!==this._lastSamplingBytes?this._lastSamplingBytes/1024:this._now()-this._lastCheckpoint>=500?this.currentKBps:0}}]),e}(),re="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ae="function"==typeof Symbol&&"symbol"===re(Symbol.iterator)?function(e){return void 0===e?"undefined":re(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":void 0===e?"undefined":re(e)},oe=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();var se=d.LOADER_EVENTS,ue=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.configs=Object.assign({},t),this.url=null,this.status=0,this.error=null,this._reader=null,this._canceled=!1,this._destroyed=!1,this.readtype=this.configs.readtype,this.buffer=this.configs.buffer||"LOADER_BUFFER",this._loaderTaskNo=0,this._ttfb=0,this._speed=new ne,window.AbortController&&(this.abortControllerEnabled=!0)}return oe(e,[{key:"init",value:function(){this.on(se.LADER_START,this.load.bind(this))}},{key:"fetch",value:function(e){function t(t,i,n){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e,t,i){var n=this,r=null;this.abortControllerEnabled&&(this.abortController=new window.AbortController),Object.assign(t,{signal:this.abortController?this.abortController.signal:void 0});var a=(new Date).getTime();return Promise.race([fetch(e,t),new Promise((function(e,t){r=setTimeout((function(){t({code:999,message:"fetch timeout"}),n.abortController&&n.abortController.abort()}),i||1e4)}))]).then((function(e){r&&(clearTimeout(r),r=null);var t=(new Date).getTime();return n.emit(se.LOADER_TTFB,{start:a,end:t,elapsed:t-a}),e}))}))},{key:"internalLoad",value:function(e,t,i,n){var r=this,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments[5];if(!this._destroyed)return this.loading=!0,this.fetch(this.url,t,o).then((function(s){if(!r._destroyed&&r.emit(se.LOADER_RESPONSE_HEADERS,r.TAG,s.headers),s.ok)return r.status=s.status,Promise.resolve().then((function(){r._onFetchResponse(s)})),Promise.resolve(s);i-- >0?r._retryTimer=setTimeout((function(){return r.emit(se.LOADER_RETRY,r.TAG,{response:s,reason:"response not ok",retryTime:n-i}),r.internalLoad(e,t,i,n,a,o)}),a):(r.loading=!1,r.emit(se.LOADER_ERROR,r.TAG,{code:s.status||21,message:s.status+" ("+s.statusText+")"}))})).catch((function(s){if(r._destroyed)r.loading=!1;else if(i-- >0)r._retryTimer=setTimeout((function(){return r.emit(se.LOADER_RETRY,r.TAG,{error:s,reason:"fetch error",retryTime:n-i}),r.internalLoad(e,t,i,n,a,o)}),a);else{if(r.loading=!1,s&&"AbortError"===s.name)return;r.emit(se.LOADER_ERROR,r.TAG,Object.assign({code:21},s))}}))}},{key:"load",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=i.retryCount,r=i.retryDelay,a=i.loadTimeout;n=void 0===n?3:n,this.url=e,this._canceled=!1;var o=this.getParams(t);return this.internalLoad(e,o,n,n,r,a)}},{key:"_onFetchResponse",value:function(e){var t=this,i=this,n=this._context.getInstance(this.buffer);this._loaderTaskNo++;var r=this._loaderTaskNo;if(!0===e.ok)switch(this.readtype){case 2:e.json().then((function(e){i.loading=!1,i._canceled||i._destroyed||(n?(n.push(e),i.emit(se.LOADER_COMPLETE,n)):i.emit(se.LOADER_COMPLETE,e))}));break;case 1:e.text().then((function(e){i.loading=!1,i._canceled||i._destroyed||(n?(n.push(e),i.emit(se.LOADER_COMPLETE,n)):i.emit(se.LOADER_COMPLETE,e))}));break;case 3:e.arrayBuffer().then((function(e){i.loading=!1,i._canceled||i._destroyed||(n?(n.push(new Uint8Array(e)),t._speed.addBytes(e.byteLength),i.emit(se.LOADER_COMPLETE,n)):i.emit(se.LOADER_COMPLETE,e))})).catch((function(){}));break;case 0:default:return this._onReader(e.body.getReader(),r)}}},{key:"_onReader",value:function(e,t){var i=this,n=this._context.getInstance(this.buffer);if(!n&&this._reader||this._destroyed)try{this._reader.cancel()}catch(e){}this._reader=e,!1!==this.loading&&(this._noDataTimer=setTimeout((function(){!1!==i.loading&&i.emit(se.LOADER_COMPLETE)}),3e3),this._reader&&this._reader.read().then((function(r){if(clearTimeout(i._noDataTimer),!i._canceled&&!i._destroyed)return r.done?(i.loading=!1,i.status=0,void Promise.resolve().then((function(){i.emit(se.LOADER_COMPLETE,n)}))):(n.push(r.value),i._speed.addBytes(r.value.byteLength),Promise.resolve().then((function(){i.emit(se.LOADER_DATALOADED,n)})),i._onReader(e,t));if(i._reader)try{i._reader.cancel()}catch(e){}})).catch((function(e){clearTimeout(i._noDataTimer),i.loading=!1,e&&"AbortError"===e.name||i.emit(se.LOADER_ERROR,i.TAG,e)})))}},{key:"getParams",value:function(e){var t=Object.assign({},e),i=new Headers,n={method:"GET",headers:i,mode:"cors",cache:"default"};if("object"===ae(this.configs.headers)){var r=this.configs.headers;for(var a in r)r.hasOwnProperty(a)&&i.append(a,r[a])}if("object"===ae(t.headers)){var o=t.headers;for(var s in o)o.hasOwnProperty(s)&&i.append(s,o[s])}return!1===t.cors&&(n.mode="same-origin"),t.withCredentials&&(n.credentials="include"),n}},{key:"cancel",value:function(){if(this._reader){try{this._reader.cancel()}catch(e){}this._reader=null,this.loading=!1}clearTimeout(this._noDataTimer),this._canceled=!0,this.abortController&&this.abortController.abort()}},{key:"destroy",value:function(){this._destroyed=!0,clearTimeout(this._retryTimer),clearTimeout(this._noDataTimer),this.cancel(),this._speed.reset()}},{key:"currentSpeed",get:function(){return this._speed.lastSamplingKBps}}],[{key:"isSupported",value:function(){return!!window.fetch}},{key:"type",get:function(){return"loader"}}]),e}(),le=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();var ce=new(function(){function e(){var t=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e);try{var i=/xgd=(\d)/.exec(document.cookie);this._status=!!i,this._level=i&&i[1]}catch(e){this._status=!1}["group","groupEnd","log","warn","error"].forEach((function(e){t[e]=function(i,n,r,a,o,s,u,l,c,h){var f;if(t._status){var d=i,p=[n,r,a,o,s,u,l,c,h].filter((function(e){return void 0!==e}));(f=console)[e].apply(f,["["+d+"]:"].concat(function(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}(p)))}}}))}return le(e,[{key:"enable",get:function(){return this._status}},{key:"long",get:function(){return"2"===this._level}}]),e}()),he=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();var fe=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return he(e,null,[{key:"getSilentFrame",value:function(e,t){if("mp4a.40.2"===e){if(1===t)return new Uint8Array([0,200,0,128,35,128]);if(2===t)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===t)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}return null}}]),e}(),de=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();var pe=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.TAG="Golomb",this._buffer=t,this._bufferIndex=0,this._totalBytes=t.byteLength,this._totalBits=8*t.byteLength,this._currentWord=0,this._currentWordBitsLeft=0}return de(e,[{key:"destroy",value:function(){this._buffer=null}},{key:"_fillCurrentWord",value:function(){var e=this._totalBytes-this._bufferIndex,t=Math.min(4,e),i=new Uint8Array(4);i.set(this._buffer.subarray(this._bufferIndex,this._bufferIndex+t)),this._currentWord=new DataView(i.buffer).getUint32(0),this._bufferIndex+=t,this._currentWordBitsLeft=8*t}},{key:"readBits",value:function(e){var t=Math.min(this._currentWordBitsLeft,e),i=this._currentWord>>>32-t;if(e>32)throw new Error("Cannot read more than 32 bits at a time");return this._currentWordBitsLeft-=t,this._currentWordBitsLeft>0?this._currentWord<<=t:this._totalBytes-this._bufferIndex>0&&this._fillCurrentWord(),(t=e-t)>0&&this._currentWordBitsLeft?i<<t|this.readBits(t):i}},{key:"readBool",value:function(){return 1===this.readBits(1)}},{key:"readByte",value:function(){return this.readBits(8)}},{key:"_skipLeadingZero",value:function(){var e=void 0;for(e=0;e<this._currentWordBitsLeft;e++)if(0!=(this._currentWord&2147483648>>>e))return this._currentWord<<=e,this._currentWordBitsLeft-=e,e;return this._fillCurrentWord(),e+this._skipLeadingZero()}},{key:"readUEG",value:function(){var e=this._skipLeadingZero();return this.readBits(e+1)-1}},{key:"readSEG",value:function(){var e=this.readUEG();return 1&e?e+1>>>1:-1*(e>>>1)}},{key:"readSliceType",value:function(){return this.readByte(),this.readUEG(),this.readUEG()}}]),e}(),ve=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();var ye=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return ve(e,null,[{key:"_ebsp2rbsp",value:function(e){for(var t=e,i=t.byteLength,n=new Uint8Array(i),r=0,a=0;a<i;a++)a>=2&&3===t[a]&&0===t[a-1]&&0===t[a-2]||(n[r]=t[a],r++);return new Uint8Array(n.buffer,0,r)}},{key:"parseSPS",value:function(t){var i=e._ebsp2rbsp(t),n=new pe(i);n.readByte();var r=n.readByte();n.readByte();var a=n.readByte();n.readUEG();var o=e.getProfileString(r),s=e.getLevelString(a),u=1,l=420,c=8;if((100===r||110===r||122===r||244===r||44===r||83===r||86===r||118===r||128===r||138===r||144===r)&&(3===(u=n.readUEG())&&n.readBits(1),u<=3&&(l=[0,420,422,444][u]),c=n.readUEG()+8,n.readUEG(),n.readBits(1),n.readBool()))for(var h=3!==u?8:12,f=0;f<h;f++)n.readBool()&&(f<6?e._skipScalingList(n,16):e._skipScalingList(n,64));n.readUEG();var d=n.readUEG();if(0===d)n.readUEG();else if(1===d){n.readBits(1),n.readSEG(),n.readSEG();for(var p=n.readUEG(),v=0;v<p;v++)n.readSEG()}n.readUEG(),n.readBits(1);var y=n.readUEG(),_=n.readUEG(),m=n.readBits(1);0===m&&n.readBits(1),n.readBits(1);var g=0,E=0,b=0,k=0;n.readBool()&&(g=n.readUEG(),E=n.readUEG(),b=n.readUEG(),k=n.readUEG());var A=1,S=1,T=0,D=!0,w=0,R=0;if(n.readBool()){if(n.readBool()){var O=n.readByte();O>0&&O<16?(A=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2][O-1],S=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1][O-1]):255===O&&(A=n.readByte()<<8|n.readByte(),S=n.readByte()<<8|n.readByte())}if(n.readBool()&&n.readBool(),n.readBool()&&(n.readBits(4),n.readBool()&&n.readBits(24)),n.readBool()&&(n.readUEG(),n.readUEG()),n.readBool()){var L=n.readBits(32),x=n.readBits(32);D=n.readBool(),T=(w=x)/(R=2*L)}}var B=1;1===A&&1===S||(B=A/S);var P=0,C=0;0===u?(P=1,C=2-m):(P=3===u?1:2,C=(1===u?2:1)*(2-m));var M=16*(y+1),I=16*(_+1)*(2-m);M-=(g+E)*P,I-=(b+k)*C;var U=Math.ceil(M*B);return n.destroy(),n=null,{profile_string:o,level_string:s,bit_depth:c,chroma_format:l,chroma_format_string:e.getChromaFormatString(l),frame_rate:{fixed:D,fps:T,fps_den:R,fps_num:w},par_ratio:{width:A,height:S},codec_size:{width:M,height:I},present_size:{width:U,height:I}}}},{key:"_skipScalingList",value:function(e,t){for(var i=8,n=8,r=0;r<t;r++)0!==n&&(n=(i+e.readSEG()+256)%256),i=0===n?i:n}},{key:"getProfileString",value:function(e){switch(e){case 66:return"Baseline";case 77:return"Main";case 88:return"Extended";case 100:return"High";case 110:return"High10";case 122:return"High422";case 244:return"High444";default:return"Unknown"}}},{key:"getLevelString",value:function(e){return(e/10).toFixed(1)}},{key:"getChromaFormatString",value:function(e){switch(e){case 420:return"4:2:0";case 422:return"4:2:2";case 444:return"4:4:4";default:return"Unknown"}}},{key:"toVideoMeta",value:function(e){var t={};e&&e.codec_size&&(t.codecWidth=e.codec_size.width,t.codecHeight=e.codec_size.height,t.presentWidth=e.present_size.width,t.presentHeight=e.present_size.height),t.profile=e.profile_string,t.level=e.level_string,t.bitDepth=e.bit_depth,t.chromaFormat=e.chroma_format,t.parRatio={width:e.par_ratio.width,height:e.par_ratio.height},t.frameRate=e.frame_rate;var i=t.frameRate.fps_den,n=t.frameRate.fps_num;return t.refSampleDuration=Math.floor(t.timescale*(i/n)),t}}]),e}(),_e=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();var me=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return _e(e,null,[{key:"EBSP2RBSP",value:function(e){return e.filter((function(t,i){return i<2||!(0===e[i-2]&&0===e[i-1]&&3===t)}))}},{key:"EBSP2SODB",value:function(e){var t=e[e.byteLength-1];return t&&128===t?e.slice(0,e.byteLength-1):e}}]),e}(),ge=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();var Ee=function(e){for(var t="",i=0;i<e.byteLength;i++)t+=String.fromCharCode(e[i]);return t},be=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return ge(e,null,[{key:"_resolveNalu",value:function(e){return e.length>=1?me.EBSP2SODB(me.EBSP2RBSP(e.slice(1))):null}},{key:"parse",value:function(t){var i=e._resolveNalu(t),n=e.switchPayloadType(i),r=n.payloadType,a=n.offset,o=i.slice(a);switch(r){case 5:return e.user_data_unregistered(o);default:return{code:r,content:o}}}},{key:"switchPayloadType",value:function(e){for(var t=new DataView(e.buffer),i=0,n=0;255===t.getUint8(n);)n++,i+=255;return{payloadType:i+=t.getUint8(n++),offset:n}}},{key:"getPayloadLength",value:function(e){for(var t=new DataView(e.buffer),i=0,n=0;255===t.getUint8(n);)n++,i+=255;return{payloadLength:i+=t.getUint8(n++),offset:n}}},{key:"user_data_unregistered",value:function(t){var i=e.getPayloadLength(t),n=i.payloadLength,r=i.offset;if(n<16)return{uuid:"",content:null};var a=t.slice(r);return{code:5,uuid:Ee(a.slice(0,16)),content:Ee(a.slice(16,n))}}}]),e}(),ke=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();var Ae=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return ke(e,null,[{key:"getNalunits",value:function(t){if(t.length-t.position<4)return[];var i=t.dataview,n=t.position;return 1===i.getInt32(n)||0===i.getInt16(n)&&1===i.getInt8(n+2)?e.getAnnexbNals(t):e.getAvccNals(t)}},{key:"getAnnexbNals",value:function(t){for(var i=[],n=e.getHeaderPositionAnnexB(t),r=n.pos,a=r;r<t.length-4;){var o=t.buffer.slice(r,r+n.headerLength);n.pos===t.position&&t.skip(n.headerLength),a=(n=e.getHeaderPositionAnnexB(t)).pos;var s={header:o,body:new Uint8Array(t.buffer.slice(r+o.byteLength,a))};e.analyseNal(s),s.type<=9&&0!==s.type&&i.push(s),t.skip(a-t.position),r=a}return i}},{key:"getAvccNals",value:function(t){for(var i=[];t.position<t.length-4;){var n=t.dataview.getInt32(t.dataview.position);if(!(t.length-t.position>=n))break;var r=t.buffer.slice(t.position,t.position+4);t.skip(4);var a=new Uint8Array(t.buffer.slice(t.position,t.position+n));t.skip(n);var o={header:r,body:a};e.analyseNal(o),o.type<=9&&0!==o.type&&i.push(o)}return i}},{key:"analyseNal",value:function(e){var t=31&e.body[0];switch(e.type=t,t){case 1:e.ndr=!0;break;case 5:e.idr=!0;break;case 6:try{e.sei=be.parse(e.body)}catch(e){}break;case 7:e.sps=ye.parseSPS(e.body);break;case 8:e.pps=!0}}},{key:"getHeaderPositionAnnexB",value:function(e){for(var t=e.position,i=0,n=e.length;3!==i&&4!==i&&t<n-4;)0===e.dataview.getInt16(t)?1===e.dataview.getInt16(t+2)?i=4:1===e.dataview.getInt8(t+2)?i=3:t++:t++;return t===n-4&&(0===e.dataview.getInt16(t)?1===e.dataview.getInt16(t+2)?i=4:t=n:(t++,0===e.dataview.getInt16(t)&&1===e.dataview.getInt8(t)?i=3:t=n)),{pos:t,headerLength:i}}},{key:"getAvcc",value:function(e,t){var i=new Uint8Array(e.byteLength+t.byteLength+11);i[0]=1,i[1]=e[1],i[2]=e[2],i[3]=e[3],i[4]=255,i[5]=225;var n=6;return i.set(new Uint8Array([e.byteLength>>>8&255,255&e.byteLength]),n),n+=2,i.set(e,n),i[n+=e.byteLength]=1,n++,i.set(new Uint8Array([t.byteLength>>>8&255,255&t.byteLength]),n),n+=2,i.set(t,n),i}}]),e}(),Se=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();var Te=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.TAG="Golomb",this._buffer=t,this._bufferIndex=0,this._totalBytes=t.byteLength,this._totalBits=8*t.byteLength,this._currentWord=0,this._currentWordBitsLeft=0}return Se(e,[{key:"destroy",value:function(){this._buffer=null}},{key:"_fillCurrentWord",value:function(){var e=this._totalBytes-this._bufferIndex,t=Math.min(4,e),i=new Uint8Array(4);i.set(this._buffer.subarray(this._bufferIndex,this._bufferIndex+t)),this._currentWord=new DataView(i.buffer).getUint32(0),this._bufferIndex+=t,this._currentWordBitsLeft=8*t}},{key:"readBits",value:function(e){var t=Math.min(this._currentWordBitsLeft,e),i=this._currentWord>>>32-t;if(e>32)throw new Error("Cannot read more than 32 bits at a time");return this._currentWordBitsLeft-=t,this._currentWordBitsLeft>0?this._currentWord<<=t:this._totalBytes-this._bufferIndex>0&&this._fillCurrentWord(),(t=e-t)>0&&this._currentWordBitsLeft?i<<t|this.readBits(t):i}},{key:"readBool",value:function(){return 1===this.readBits(1)}},{key:"readByte",value:function(){return this.readBits(8)}},{key:"_skipLeadingZero",value:function(){var e=void 0;for(e=0;e<this._currentWordBitsLeft;e++)if(0!=(this._currentWord&2147483648>>>e))return this._currentWord<<=e,this._currentWordBitsLeft-=e,e;return this._fillCurrentWord(),e+this._skipLeadingZero()}},{key:"readUEG",value:function(){var e=this._skipLeadingZero();return this.readBits(e+1)-1}},{key:"readSEG",value:function(){var e=this.readUEG();return 1&e?e+1>>>1:-1*(e>>>1)}},{key:"readSliceType",value:function(){return this.readByte(),this.readUEG(),this.readUEG()}}]),e}(),De=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();var we=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return De(e,null,[{key:"_ebsp2rbsp",value:function(e){for(var t=e,i=t.byteLength,n=new Uint8Array(i),r=0,a=0;a<i;a++)a>=2&&3===t[a]&&0===t[a-1]&&0===t[a-2]||(n[r]=t[a],r++);return new Uint8Array(n.buffer,0,r)}},{key:"parseSPS",value:function(t){var i,n,r,a,o,s,u=e._ebsp2rbsp(t),l=new Te(u),c=0,h=0,f=0,d=0,p=0,v=0,y=0,_=0,m=0;return l.readByte(),l.readByte(),l.readBits(4),i=l.readBits(3),l.readBits(1),s=e._readProfileTierLevel(l,i),l.readUEG(),3===(n=l.readUEG())&&(c=l.readBits(1)),h=l.readUEG(),f=l.readUEG(),1===(r=l.readBits(1))&&(d=l.readUEG(),p=l.readUEG(),v=l.readUEG(),y=l.readUEG()),a=l.readUEG(),o=l.readUEG(),1===r&&(h-=(_=1!==n&&2!==n||0!==c?1:2)*p+_*d,f-=(m=1===n&&0===c?2:1)*y+m*v),l.destroy(),l=null,{width:h,height:f,general_profile_space:s.general_profile_space,general_tier_flag:s.general_tier_flag,general_profile_idc:s.general_profile_idc,general_level_idc:s.general_level_idc,chromaFormatIdc:n,bitDepthLumaMinus8:a,bitDepthChromaMinus8:o}}},{key:"_readProfileTierLevel",value:function(e,t){var i,n,r,a;i=e.readBits(2)||0,n=e.readBits(1)||0,r=e.readBits(5)||0,e.readBits(16),e.readBits(16),e.readBits(1),e.readBits(1),e.readBits(1),e.readBits(1),e.readBits(16),e.readBits(16),e.readBits(12),a=e.readBits(8)||0;for(var o=[],s=[],u=0;u<t;u++)o[u]=e.readBits(1),s[u]=e.readBits(1);t>0&&e.readBits(2*(8-t));for(var l=0;l<t;l++)0!==o[l]&&(e.readBits(2),e.readBits(1),e.readBits(5),e.readBits(16),e.readBits(16),e.readBits(4),e.readBits(16),e.readBits(16),e.readBits(12)),0!==s[l]&&e.readBits(8);return{general_profile_space:i,general_tier_flag:n,general_profile_idc:r,general_level_idc:a}}},{key:"_skipScalingList",value:function(e,t){for(var i=8,n=8,r=0;r<t;r++)0!==n&&(n=(i+e.readSEG()+256)%256),i=0===n?i:n}},{key:"getProfileString",value:function(e){switch(e){case 66:return"Baseline";case 77:return"Main";case 88:return"Extended";case 100:return"High";case 110:return"High10";case 122:return"High422";case 244:return"High444";default:return"Unknown"}}},{key:"getLevelString",value:function(e){return(e/10).toFixed(1)}},{key:"getChromaFormatString",value:function(e){switch(e){case 420:return"4:2:0";case 422:return"4:2:2";case 444:return"4:4:4";default:return"Unknown"}}},{key:"toVideoMeta",value:function(e){var t={};return e&&e.codec_size?(t.codecWidth=e.codec_size.width,t.codecHeight=e.codec_size.height,t.presentWidth=e.present_size.width,t.presentHeight=e.present_size.height):e.width&&e.height&&(t.codecWidth=e.width,t.codecHeight=e.height,t.presentWidth=e.width,t.presentHeight=e.height),t.profile=e.profile_string,t.level=e.level_string,t.bitDepth=e.bit_depth,t.chromaFormat=e.chroma_format,t}}]),e}(),Re=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();var Oe=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return Re(e,null,[{key:"EBSP2RBSP",value:function(e){return e.filter((function(t,i){return i<2||!(0===e[i-2]&&0===e[i-1]&&3===t)}))}},{key:"EBSP2SODB",value:function(e){var t=e[e.byteLength-1];return t&&128===t?e.slice(0,e.byteLength-1):e}}]),e}(),Le=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();var xe=function(e){for(var t="",i=0;i<e.byteLength;i++)t+=String.fromCharCode(e[i]);return t},Be=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return Le(e,null,[{key:"_resolveNalu",value:function(e){return e.length>=1?Oe.EBSP2SODB(Oe.EBSP2RBSP(e.slice(1))):null}},{key:"parse",value:function(t){var i=e._resolveNalu(t),n=e.switchPayloadType(i),r=n.payloadType,a=n.offset,o=i.slice(a);switch(r){case 5:return e.user_data_unregistered(o);default:return{code:r,content:o}}}},{key:"switchPayloadType",value:function(e){for(var t=new DataView(e.buffer),i=0,n=0;255===t.getUint8(n);)n++,i+=255;return{payloadType:i+=t.getUint8(n++),offset:n}}},{key:"getPayloadLength",value:function(e){for(var t=new DataView(e.buffer),i=0,n=0;255===t.getUint8(n);)n++,i+=255;return{payloadLength:i+=t.getUint8(n++),offset:n}}},{key:"user_data_unregistered",value:function(t){var i=e.getPayloadLength(t),n=i.payloadLength,r=i.offset;if(n<16)return{uuid:"",content:null};var a=t.slice(r);return{code:5,uuid:xe(a.slice(0,16)),content:xe(a.slice(16,n))}}}]),e}(),Pe=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();var Ce=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return Pe(e,null,[{key:"getNalunits",value:function(t){if(t.length-t.position<4)return[];var i=t.dataview,n=t.position;return 1===i.getInt32(n)||0===i.getInt16(n)&&1===i.getInt8(n+2)?e.getAnnexbNals(t):e.getHvccNals(t)}},{key:"getAnnexbNals",value:function(t){for(var i=[],n=e.getHeaderPositionAnnexB(t),r=n.pos,a=r;r<t.length-4;){var o=t.buffer.slice(r,r+n.headerLength);n.pos===t.position&&t.skip(n.headerLength),a=(n=e.getHeaderPositionAnnexB(t)).pos;var s={header:o,body:new Uint8Array(t.buffer.slice(r+o.byteLength,a))};e.analyseNal(s),s.type<=40&&i.push(s),t.skip(a-t.position),r=a}return i}},{key:"getHvccNals",value:function(t){for(var i=[];t.position<t.length-4;){var n=t.dataview.getInt32(t.dataview.position);if(!(t.length-t.position>=n))break;var r=t.buffer.slice(t.position,t.position+4);t.skip(4);var a=new Uint8Array(t.buffer.slice(t.position,t.position+n));t.skip(n);var o={header:r,body:a};try{e.analyseNal(o)}catch(e){continue}o.type<=40&&i.push(o)}return i}},{key:"analyseNal",value:function(e){var t=e.body[0]>>>1&63;switch(e.type=t,t){case 0:e.slice_trail_n=!0;break;case 1:e.slice_trail_r=!0,e.key=!0;break;case 2:e.slice_tsa_n=!0;break;case 3:e.slice_tsa_r=!0,e.key=!0;break;case 4:e.slice_stsa_n=!0;break;case 5:e.slice_stsa_r=!0,e.key=!0;break;case 6:e.slice_radl_n=!0;break;case 7:e.slice_radl_r=!0,e.key=!0;break;case 8:e.slice_rasl_n=!0;break;case 9:e.slice_rasl_r=!0,e.key=!0;break;case 16:e.slice_bla_w_lp=!0;break;case 17:e.slice_bla_w_radl=!0;break;case 18:e.slice_bla_n_lp=!0;break;case 19:e.slice_idl_w_radl=!0,e.key=!0;break;case 20:e.slice_idr_n_lp=!0,e.key=!0;break;case 21:e.slice_cra_nut=!0,e.key=!0;break;case 32:e.vps=!0;break;case 33:e.sps=we.parseSPS(e.body);break;case 34:e.pps=!0;break;case 35:break;case 36:e.aud=!0;break;case 37:e.eob=!0;break;case 38:e.fd=!0;break;case 39:try{e.sei=Be.parse(e.body.slice(1))}catch(e){}break;case 40:e.sei=Be.parse(e.body.slice(1))}}},{key:"getHeaderPositionAnnexB",value:function(e){for(var t=e.position,i=0,n=e.length;3!==i&&4!==i&&t<n-4;)0===e.dataview.getInt16(t)?1===e.dataview.getInt16(t+2)?i=4:1===e.dataview.getInt8(t+2)?i=3:t++:t++;return t===n-4&&(0===e.dataview.getInt16(t)?1===e.dataview.getInt16(t+2)&&(i=4):(t++,0===e.dataview.getInt16(t)&&1===e.dataview.getInt8(t)?i=3:t=n)),{pos:t,headerLength:i}}}]),e}(),Me=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();function Ie(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}var Ue=d.REMUX_EVENTS,Ve=function(){function e(){var t=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.TAG="Compatibility",this.nextAudioDts=0,this.nextVideoDts=0,this.lastAudioSamplesLen=0,this.lastVideoSamplesLen=0,this.lastVideoDts=void 0,this.lastAudioDts=void 0,this.allAudioSamplesCount=0,this.allVideoSamplesCount=0,this._firstAudioSample=null,this._firstVideoSample=null,this.filledAudioSamples=[],this.filledVideoSamples=[],this.videoLastSample=null,this.audioLastSample=null,Object.defineProperties(this,{_videoLargeGap:{set:function(e){t.___videoLargeGap=e,0!==e&&t.emit(Ue.DETECT_LARGE_GAP,"video",e)},get:function(){return t.___videoLargeGap||0}},_audioLargeGap:{set:function(e){t.___audioLargeGap=e,0!==e&&t.emit(Ue.DETECT_LARGE_GAP,"audio",e)},get:function(){return t.___audioLargeGap||0}}}),this.audioUnsyncTime=0}return Me(e,[{key:"init",value:function(){this.before(Ue.REMUX_MEDIA,this.doFix.bind(this))}},{key:"reset",value:function(){this.nextAudioDts=null,this.nextVideoDts=null,this.lastAudioSamplesLen=0,this.lastVideoSamplesLen=0,this.lastVideoDts=void 0,this.lastAudioDts=void 0,this.lastVideoDuration=void 0,this._audioLargeGap=0,this._videoLargeGap=0,this.videoLastSample=null,this.audioLastSample=null,this.filledAudioSamples=[],this.filledVideoSamples=[],this.audioUnsyncTime=0}},{key:"doFix",value:function(){var t=this.getFirstSample(),i=t.isFirstAudioSamples,n=t.isFirstVideoSamples;this.recordSamplesCount(),this._firstVideoSample&&this.fixVideoRefSampleDuration(this.videoTrack.meta,this.videoTrack.samples);var r=e.detectChangeStream(this.videoTrack.samples,n),a=r.changed,o=r.changedIdxes;if(a){for(var s=!1,u=0;u<o.length;u++)this.fixChangeStreamVideo(o[u],n)&&(s=!0);s||this.doFixVideo(n)}else this.doFixVideo(n);var l=e.detectChangeStream(this.audioTrack.samples,i),c=l.changed,h=l.changedIdxes;if(c){for(var f=!1,d=0;d<h.length;d++)this.fixChangeStreamAudio(h[d],i)&&(f=!0);if(f)return;this.doFixAudio(i)}else this.doFixAudio(i);this.removeInvalidSamples()}},{key:"doFixVideo",value:function(t,i){for(var n=this.videoTrack,r=n.samples,a=n.meta,o=r.length,s=0;s<o;s++){var u=r[s];u.originDts=u.dts,u.originPts=u.pts}if(r&&o&&this._firstVideoSample){var l=r[0];if(ce.log(this.TAG,"doFixVideo:: lastVideoDts: "+this.lastVideoDts+" ,  _videoLargeGap: "+this._videoLargeGap+" ,streamChangeStart:"+i+", lastVideoSample:[dts="+(this.videoLastSample&&this.videoLastSample.dts)+" , pts="+(this.videoLastSample&&this.videoLastSample.pts)+"] ,  firstDTS:"+l.dts+" ,firstPTS:"+l.pts+" ,lastDTS:"+r[o-1].dts+" , lastPTS: "+r[o-1].pts),!t&&null===this.videoLastSample&&l.options&&l.options.start&&void 0!==i&&(i=l.options.start),!t&&void 0===i&&this.videoLastSample&&e.detectVideoLargeGap(this.videoLastSample?this.videoLastSample.dts:0,l.dts+this._videoLargeGap)&&(this._videoLargeGap=this.videoLastSample.dts+a.refSampleDuration-l.dts),0!==this._videoLargeGap&&(e.doFixLargeGap(r,this._videoLargeGap),this._videoLargeGap!==this.preVideoGap&&(this.preVideoGap=this._videoLargeGap,this.emit(Ue.DETECT_CHANGE_STREAM_DISCONTINUE,"video",{prevDts:this.videoLastSample&&this.videoLastSample.originDts,curDts:l.originDts,duration:a.refSampleDuration}))),t||void 0===i||(this._videoLargeGap=i-l.dts,e.doFixLargeGap(r,this._videoLargeGap)),t&&this._firstAudioSample){var c=this._firstVideoSample.originDts,h=c-(this._firstAudioSample.originDts||this._firstAudioSample.dts);if(h>2*a.refSampleDuration&&h<10*a.refSampleDuration){for(var f=Math.floor(h/a.refSampleDuration),d=0;d<f;d++){var p=Object.assign({},l);p.dts=c-(d+1)*a.refSampleDuration,p.pts=p.dts+p.cts,r.unshift(p),this.filledVideoSamples.push({dts:p.dts,size:p.data.byteLength})}this._firstVideoSample=this.filledVideoSamples[0]||this._firstVideoSample}else Math.abs(h)>2*a.refSampleDuration&&!this._videoLargeGap&&(this._videoLargeGap=-1*h,e.doFixLargeGap(r,-1*h))}var v=r.pop();if(r.length&&(r[r.length-1].duration=v.dts-r[r.length-1].dts),this.videoLastSample){var y=this.videoLastSample;y.duration=l.dts-y.dts,r.unshift(this.videoLastSample)}this.videoLastSample=v,r[r.length-1]&&(this.lastVideoDuration=r[r.length-1].duration,this.lastVideoDts=r[r.length-1].dts),this.videoTrack.samples=r}}},{key:"doFixAudio",value:function(t,i){var n=this,r=this.audioTrack,a=r.samples,o=r.meta;if(a&&a.length){this.fixAudioRefSampleDuration(o);for(var s=0,u=a.length;s<u;s++){var l=a[s];l.originDts=l.dts}var c=a.length,h=fe.getSilentFrame(o.codec,o.channelCount),f=Math.floor(o.refSampleDuration),d=this._firstAudioSample,p=a[0];if(ce.log(this.TAG,"doFixAudio:: audioDtsBase:"+this.audioDtsBase+" ,  _audioLargeGap: "+this._audioLargeGap+", streamChangeStart:"+i+" ,  nextAudioDts:"+this.nextAudioDts+",  audio: firstDTS:"+p.dts+" ,firstPTS:"+p.pts+" ,lastDTS:"+a[c-1].dts+" , lastPTS: "+a[c-1].pts),!t&&null===this.nextAudioDts&&p.options&&p.options.start&&void 0!==i&&(i=p.options.start),!t&&void 0===i&&this.nextAudioDts&&e.detectAudioLargeGap(this.nextAudioDts||0,p.dts+this._audioLargeGap)){var v=this.nextAudioDts-p.dts;this._audioLargeGap=Math.abs(v-this._videoLargeGap)<200?this._videoLargeGap:v}if(0!==this._audioLargeGap?(this._audioLargeGap>0&&e.doFixLargeGap(a,this._audioLargeGap),this._audioLargeGap!==this.preAudioGap&&(this.preAudioGap=this._audioLargeGap,this.emit(Ue.DETECT_CHANGE_STREAM_DISCONTINUE,"audio",{prevDts:this.lastAudioOriginDts,curDts:p.originDts,duration:f}))):t||void 0===i&&!e.detectAudioLargeGap(this.nextAudioDts,p.dts)||(void 0!==i&&(this.nextAudioDts=i),this._audioLargeGap=this.nextAudioDts-p.dts,p.options.start&&!p.options.start.isContinue&&e.doFixLargeGap(a,this._audioLargeGap)),this._firstVideoSample&&t){var y=this._firstVideoSample.originDts||this._firstVideoSample.dts,_=d.dts-y;if(_===this._videoLargeGap);else if(_>o.refSampleDuration&&_<10*o.refSampleDuration){for(var m=Math.floor((d.dts-y)/o.refSampleDuration),g=0;g<m;g++){var E={data:h,datasize:h.byteLength,dts:d.dts-(g+1)*o.refSampleDuration,filtered:0};a.unshift(E),this.filledAudioSamples.push({dts:E.dts,size:E.data.byteLength})}this._firstAudioSample=this.filledAudioSamples[0]||this._firstAudioSample}else _<-1*o.refSampleDuration&&(this._audioLargeGap=-1*_,e.doFixLargeGap(a,-1*_))}var b=void 0,k=a[0].dts;if(this.nextAudioDts){b=k-this.nextAudioDts;var A=Math.abs(b);if(b>=f&&b<1e4&&h){for(var S=Math.ceil(b/f),T=0;T<S;T++){var D=k-(T+1)*f,w={dts:D>this.nextAudioDts?D:this.nextAudioDts,pts:D>this.nextAudioDts?D:this.nextAudioDts,datasize:h.byteLength,filtered:0,data:h};this.filledAudioSamples.push({dts:w.dts,size:w.data.byteLength}),this.audioTrack.samples.unshift(w),p=w}this.emit(Ue.DETECT_AUDIO_GAP,b,S)}else A<o.refSampleDuration&&A>0?(p.dts=this.nextAudioDts,p.pts=this.nextAudioDts):b<0&&A<f&&(e.doFixLargeGap(a,-1*b),this.emit(Ue.DETECT_AUDIO_OVERLAP,b))}for(var R=a[0].dts+f,O=1;O<a.length;){var L=a[O],x=L.dts-R;if(x<=-1*f)ce.warn("drop 1 audio sample for "+x+" ms overlap"),a.splice(O,1);else if(x>=10*f){var B=Math.round(x/f);if(B>1e3)break;ce.warn(this.TAG,"inject "+B+" audio frame for "+x+" ms gap");for(var P=0;P<B;P++){var C={data:h,datasize:h.byteLength,dts:R,originDts:R,filtered:0};a.splice(O,0,C),R+=f,O++}L.dts=L.pts=L.originDts=R,R+=f,O++}else L.dts=L.pts=L.originDts=R,R+=f,O++}var M=o.refSampleDuration-f;a.forEach((function(e,t){if(0!==t){var i=a[t-1];e.dts=e.pts=i.dts+i.duration}e.duration=f,n.audioUnsyncTime=n.audioUnsyncTime+M,n.audioUnsyncTime>=1&&(e.duration+=1,n.audioUnsyncTime-=1)}));var I=a[a.length-1];this.lastAudioDts=I.dts;var U=I.duration;this.lastAudioSamplesLen=c,this.nextAudioDts=this.lastAudioDts+(U||f),this.lastAudioOriginDts=I.originDts,this.audioTrack.samples=e.sortAudioSamples(a)}}},{key:"fixChangeStreamVideo",value:function(e){ce.log(this.TAG,"fixChangeStreamVideo(), changeIdx=",e);var t=this.videoTrack,i=t.samples,n=t.meta,r=0===e&&this.lastVideoDuration?this.lastVideoDuration:n.refSampleDuration,a=0===e?this.lastVideoDts?this.lastVideoDts:this.getStreamChangeStart(i[0]):i[e-1].dts,o=i[e].dts,s=Math.abs(a-o)<=1e4;if(this.emit(Ue.DETECT_CHANGE_STREAM,"video",o),s)return i[e].options?i[e].options.isContinue=!0:i[e].options={isContinue:!0},!1;this.emit(Ue.DETECT_CHANGE_STREAM_DISCONTINUE,"video",{prevDts:a,curDts:o,duration:r});var u=i.slice(0,e),l=i.slice(e),c=i[e],h=void 0;return this._videoLargeGap=0,this.videoLastSample=null,this.lastVideoDts=null,this.lastVideoDuration=null,h=c.options&&void 0!==c.options.start?c.options.start:a-this.videoDtsBase,this.videoTrack.samples=i.slice(0,e),this.doFixVideo(!1),this.videoTrack.samples=i.slice(e),this.doFixVideo(!1,h),this.videoTrack.samples=u.concat(l),!0}},{key:"fixChangeStreamAudio",value:function(e){ce.log(this.TAG,"fixChangeStreamAudio(), changeIdx=",e);var t=this.audioTrack,i=t.samples,n=t.meta,r=0===e?this.lastAudioDts:i[e-1].dts,a=i[e].dts,o=Math.abs(r-a)<=1e4;if(this.emit(Ue.DETECT_CHANGE_STREAM,"audio",a),o)return i[e].options?i[e].options.isContinue=!0:i[e].options={isContinue:!0},!1;this.emit(Ue.DETECT_CHANGE_STREAM_DISCONTINUE,"audio",{prevDts:r,curDts:a,duration:n.refSampleDuration}),this._audioLargeGap=0;var s=this.nextAudioDts;this.nextAudioDts=null;var u=i.slice(0,e),l=i.slice(e),c=i[e],h=void 0;return c.options&&void 0!==c.options.start?h=c.options.start:(h=s,c.options.isContinue=!0),this.audioTrack.samples=u,this.doFixAudio(!1),this.audioTrack.samples=l,this.doFixAudio(!1,h),this.audioTrack.samples=u.concat(l),!0}},{key:"getFirstSample",value:function(){var t=this.videoTrack.samples,i=this.audioTrack.samples,n=!1,r=!1;return!this._firstVideoSample&&t.length&&(this._firstVideoSample=e.findFirstVideoSample(t),this.removeInvalidSamples(),n=!0),!this._firstAudioSample&&i.length&&(this._firstAudioSample=e.findFirstAudioSample(i),this.removeInvalidSamples(),r=!0),{isFirstVideoSamples:n,isFirstAudioSamples:r}}},{key:"fixVideoRefSampleDuration",value:function(t,i){if(t){var n=this.allVideoSamplesCount,r=this._firstVideoSample.dts,a=this.filledVideoSamples.length;if(e.isRefSampleDurationValid(t.refSampleDuration)){if(t.refSampleDuration&&i.length>=5){var o=(i[i.length-1].dts-i[0].dts)/(i.length-1);if(o>0&&o<1e3){var s=Math.floor(Math.abs(t.refSampleDuration-o)<=5?t.refSampleDuration:o);e.isRefSampleDurationValid(s)&&(t.refSampleDuration=s)}}}else if(i.length>=1){var u=i[i.length-1].dts,l=Math.floor((u-r)/(n+a-1));e.isRefSampleDurationValid(l)&&(t.refSampleDuration=l)}e.isRefSampleDurationValid(t.refSampleDuration)||(t.refSampleDuration=66)}}},{key:"fixAudioRefSampleDuration",value:function(e){e&&(e.refSampleDuration=1024*e.timescale/e.sampleRate)}},{key:"recordSamplesCount",value:function(){var e=this.audioTrack,t=this.videoTrack;this.allAudioSamplesCount+=e.samples.length,this.allVideoSamplesCount+=t.samples.length}},{key:"removeInvalidSamples",value:function(){var e=this.audioTrack.samples[0],t=this.videoTrack.samples[0];e&&(this.audioTrack.samples=this.audioTrack.samples.filter((function(t,i){return t===e||t.dts>=e.dts}))),t&&(this.videoTrack.samples=this.videoTrack.samples.filter((function(e,i){return e===t||e.dts>=t.dts})))}},{key:"getStreamChangeStart",value:function(e){return e.options&&e.options.start?e.options.start-this.dtsBase:1/0}},{key:"tracks",get:function(){return this._context.getInstance("TRACKS")}},{key:"audioTrack",get:function(){return this.tracks&&this.tracks.audioTrack?this.tracks.audioTrack:{samples:[],meta:{}}}},{key:"videoTrack",get:function(){return this.tracks&&this.tracks.videoTrack?this.tracks.videoTrack:{samples:[],meta:{}}}},{key:"dtsBase",get:function(){var e=this._context.getInstance("MP4_REMUXER");return e?e._dtsBase:0}},{key:"audioDtsBase",get:function(){var e=this._context.getInstance("MP4_REMUXER");return e&&null!==e._audioDtsBase?e._audioDtsBase:this.dtsBase}},{key:"videoDtsBase",get:function(){var e=this._context.getInstance("MP4_REMUXER");return e&&null!==e._videoDtsBase?e._videoDtsBase:this.dtsBase}}],[{key:"sortAudioSamples",value:function(e){return 1===e.length?e:[].concat(Ie(e)).sort((function(e,t){return e.dts-t.dts}))}},{key:"isRefSampleDurationValid",value:function(e){return e&&e>0&&!Number.isNaN(e)}},{key:"findFirstAudioSample",value:function(t){return t&&0!==t.length?e.sortAudioSamples(t)[0]:null}},{key:"findFirstVideoSample",value:function(e){if(!e.length)return null;for(var t=[].concat(Ie(e)).sort((function(e,t){return e.dts-t.dts})),i=0,n=t.length;i<n;i++)if(t[i].isKeyframe)return t[i]}},{key:"detectVideoLargeGap",value:function(e,t){if(null!==e){return e-t>=1e4||t-e>=1e4}}},{key:"detectAudioLargeGap",value:function(e,t){if(null!==e)return e-t>=1e3||t-e>=1e3}},{key:"doFixLargeGap",value:function(e,t){for(var i=0,n=e.length;i<n;i++){var r=e[i];r.dts+=t,r.pts&&(r.pts+=t)}}},{key:"detectChangeStream",value:function(e,t){for(var i=!1,n=[],r=0,a=e.length;r<a;r++){var o=e[r];!o.options||!o.options.meta||t&&0===r||(i=!0,n.push(r))}return{changed:i,changedIdxes:n}}}]),e}(),Ne=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();var Ge=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return Ne(e,null,[{key:"decode",value:function(t){for(var i=[],n=t,r=0,a=t.length;r<a;)if(n[r]<128)i.push(String.fromCharCode(n[r])),++r;else{if(n[r]<192);else if(n[r]<224){if(e._checkContinuation(n,r,1)){var o=(31&n[r])<<6|63&n[r+1];if(o>=128){i.push(String.fromCharCode(65535&o)),r+=2;continue}}}else if(n[r]<240){if(e._checkContinuation(n,r,2)){var s=(15&n[r])<<12|(63&n[r+1])<<6|63&n[r+2];if(s>=2048&&55296!=(63488&s)){i.push(String.fromCharCode(65535&s)),r+=3;continue}}}else if(n[r]<248&&e._checkContinuation(n,r,3)){var u=(7&n[r])<<18|(63&n[r+1])<<12|(63&n[r+2])<<6|63&n[r+3];if(u>65536&&u<1114112){u-=65536,i.push(String.fromCharCode(u>>>10|55296)),i.push(String.fromCharCode(1023&u|56320)),r+=4;continue}}i.push(String.fromCharCode(65533)),++r}return i.join("")}},{key:"_checkContinuation",value:function(e,t,i){var n=e;if(t+i<n.length){for(;i--;)if(128!=(192&n[++t]))return!1;return!0}return!1}}]),e}(),Fe=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();var je=te.isLe,He=0,ze=1,Xe=2,We=3,Ke=8,Ye=9,qe=10,Ze=11,Je=12,Qe=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.offset=0,this.readOffset=this.offset}return Fe(e,[{key:"resolve",value:function(e,t){if(t<3)throw new Error("not enough data for metainfo");var i={},n=this.parseValue(e),r=this.parseValue(e,t-n.bodySize);return i[n.data]=r.data,this.resetStatus(),i}},{key:"resetStatus",value:function(){this.offset=0,this.readOffset=this.offset}},{key:"parseString",value:function(e){var t=new DataView(e,this.readOffset).getUint16(0,!je),i="";i=t>0?Ge.decode(new Uint8Array(e,this.readOffset+2,t)):"";var n=t+2;return this.readOffset+=n,{data:i,bodySize:t+2}}},{key:"parseDate",value:function(e,t){var i=new DataView(e,this.readOffset,t),n=i.getFloat64(0,!je);return n+=60*i.getInt16(8,!je)*1e3,this.readOffset+=10,{data:new Date(n),bodySize:10}}},{key:"parseObject",value:function(e,t){var i=this.parseString(e,t),n=this.parseValue(e,t-i.bodySize);return{data:{name:i.data,value:n.data},bodySize:i.bodySize+n.bodySize,isObjEnd:n.isObjEnd}}},{key:"parseLongString",value:function(e){var t=new DataView(e,this.readOffset).getUint32(0,!je),i="";return i=t>0?Ge.decode(new Uint8Array(e,this.readOffset+2,t)):"",this.readOffset+=t+4,{data:i,bodySize:t+4}}},{key:"parseValue",value:function(e,t){var i=new ArrayBuffer;i=e instanceof ArrayBuffer?e:e.buffer;var n=He,r=ze,a=Xe,o=We,s=Ke,u=Ye,l=qe,c=Ze,h=Je,f=new DataView(i,this.readOffset,t),d=!1,p=f.getUint8(0),v=1;this.readOffset+=1;var y=null;switch(p){case n:y=f.getFloat64(1,!je),this.readOffset+=8,v+=8;break;case r:y=!!f.getUint8(1),this.readOffset+=1,v+=1;break;case a:var _=this.parseString(i);y=_.data,v+=_.bodySize;break;case o:y={};var m=0;for(16777215&f.getUint32(t-4,!je)&&(m=3);v<t-4;){var g=this.parseObject(i,t-v-m);if(g.isObjectEnd)break;y[g.data.name]=g.data.value,v+=g.bodySize}if(v<=t-3)9===(16777215&f.getUint32(v-1,!je))&&(this.readOffset+=3,v+=3);break;case s:y={},v+=4,this.readOffset+=4;var E=0;for(9==(16777215&f.getUint32(t-4,!je))&&(E=3);v<t-8;){var b=this.parseObject(i,t-v-E);if(b.isObjectEnd)break;y[b.data.name]=b.data.value,v+=b.bodySize}if(v<=t-3)9===(16777215&f.getUint32(v-1,!je))&&(v+=3,this.readOffset+=3);break;case u:y=null,d=!0;break;case l:y=[];var k=f.getUint32(1,!je);v+=4,this.readOffset+=4;for(var A=0;A<k;A++){var S=this.parseValue(i,t-v);y.push(S.data),v+=S.bodySize}break;case c:var T=this.parseDate(i,t-1);y=T.data,v+=T.bodySize;break;case h:var D=this.parseLongString(i,t-1);y=D.data,v+=D.bodySize;break;default:v=t}return{data:y,bodySize:v,isObjEnd:d}}}]),e}(),$e=j((function(e){var t=Object.prototype.hasOwnProperty,i="~";function n(){}function r(e,t,i){this.fn=e,this.context=t,this.once=i||!1}function a(e,t,n,a,o){if("function"!=typeof n)throw new TypeError("The listener must be a function");var s=new r(n,a||e,o),u=i?i+t:t;return e._events[u]?e._events[u].fn?e._events[u]=[e._events[u],s]:e._events[u].push(s):(e._events[u]=s,e._eventsCount++),e}function o(e,t){0==--e._eventsCount?e._events=new n:delete e._events[t]}function s(){this._events=new n,this._eventsCount=0}Object.create&&(n.prototype=Object.create(null),(new n).__proto__||(i=!1)),s.prototype.eventNames=function(){var e,n,r=[];if(0===this._eventsCount)return r;for(n in e=this._events)t.call(e,n)&&r.push(i?n.slice(1):n);return Object.getOwnPropertySymbols?r.concat(Object.getOwnPropertySymbols(e)):r},s.prototype.listeners=function(e){var t=i?i+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var r=0,a=n.length,o=new Array(a);r<a;r++)o[r]=n[r].fn;return o},s.prototype.listenerCount=function(e){var t=i?i+e:e,n=this._events[t];return n?n.fn?1:n.length:0},s.prototype.emit=function(e,t,n,r,a,o){var s=i?i+e:e;if(!this._events[s])return!1;var u,l,c=this._events[s],h=arguments.length;if(c.fn){switch(c.once&&this.removeListener(e,c.fn,void 0,!0),h){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,t),!0;case 3:return c.fn.call(c.context,t,n),!0;case 4:return c.fn.call(c.context,t,n,r),!0;case 5:return c.fn.call(c.context,t,n,r,a),!0;case 6:return c.fn.call(c.context,t,n,r,a,o),!0}for(l=1,u=new Array(h-1);l<h;l++)u[l-1]=arguments[l];c.fn.apply(c.context,u)}else{var f,d=c.length;for(l=0;l<d;l++)switch(c[l].once&&this.removeListener(e,c[l].fn,void 0,!0),h){case 1:c[l].fn.call(c[l].context);break;case 2:c[l].fn.call(c[l].context,t);break;case 3:c[l].fn.call(c[l].context,t,n);break;case 4:c[l].fn.call(c[l].context,t,n,r);break;default:if(!u)for(f=1,u=new Array(h-1);f<h;f++)u[f-1]=arguments[f];c[l].fn.apply(c[l].context,u)}}return!0},s.prototype.on=function(e,t,i){return a(this,e,t,i,!1)},s.prototype.once=function(e,t,i){return a(this,e,t,i,!0)},s.prototype.removeListener=function(e,t,n,r){var a=i?i+e:e;if(!this._events[a])return this;if(!t)return o(this,a),this;var s=this._events[a];if(s.fn)s.fn!==t||r&&!s.once||n&&s.context!==n||o(this,a);else{for(var u=0,l=[],c=s.length;u<c;u++)(s[u].fn!==t||r&&!s[u].once||n&&s[u].context!==n)&&l.push(s[u]);l.length?this._events[a]=1===l.length?l[0]:l:o(this,a)}return this},s.prototype.removeAllListeners=function(e){var t;return e?(t=i?i+e:e,this._events[t]&&o(this,t)):(this._events=new n,this._eventsCount=0),this},s.prototype.off=s.prototype.removeListener,s.prototype.addListener=s.prototype.on,s.prefixed=i,s.EventEmitter=s,e.exports=s})),et="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},tt=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),it=function e(t,i,n){null===t&&(t=Function.prototype);var r=Object.getOwnPropertyDescriptor(t,i);if(void 0===r){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,i,n)}if("value"in r)return r.value;var o=r.get;return void 0!==o?o.call(n):void 0};var nt=ye,rt=Ae,at=we,ot=Ce,st=function(e){function t(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var e=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==(void 0===t?"undefined":et(t))&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.headerParsed=!1,e.trackNum=0,e.hasScript=!1,e._videoMetaChange=!1,e._audioMetaChange=!1,e.gopId=0,e.onMetaData=null,e}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":et(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),tt(t,[{key:"demux",value:function(e){if(this.headerParsed){if(e.length<11)return;var t=void 0,i=1e4;do{t=this._parseFlvTag(e)}while(t&&i-- >0)}else{if(e.length<13)return;var n=e.shift(13);this.parseFlvHeader(n),this.demux(e)}}},{key:"parseFlvHeader",value:function(e){if(!t.isFlvFile(e))throw new Error("invalid flv file,"+e.join(","));this.headerParsed=!0;var i=e[4]>>>2==1,n=1==(1&e[4]);this.emit(t.EVENTS.FILE_HEADER_PARSED,{hasVideo:n,hasAudio:i})}},{key:"_parseFlvTag",value:function(e){var t=e.toInt(1,3);if(e.length<11+t+4)return null;var i=this._parseFlvTagHeader(e);if(i&&(this._processTagData(i,e),!this._datasizeValidator(i.datasize,e)))throw new Error("TAG length error at "+i.datasize);return i}},{key:"_parseFlvTagHeader",value:function(e){var t=0,i=new G,n=e.toInt(t,1);if(t+=1,i.filtered=(32&n)>>>5,i.tagType=31&n,i.datasize=e.toInt(t,3),t+=3,8!==i.tagType&&9!==i.tagType&&11!==i.tagType&&18!==i.tagType)throw e&&e.length>0&&e.shift(1),new Error("tagType "+i.tagType);if(e.length<i.datasize+15)return null;e.shift(4);var r=e.toInt(0,3);e.shift(3);var a=e.shift(1)[0];return a>0&&(r+=16777216*a),i.dts=r,e.shift(3),i}},{key:"_processTagData",value:function(e,t){switch(e.tagType){case 18:this._parseScriptData(e,t);break;case 8:this._parseAudioTag(e,t);break;case 9:this._parseVideoData(e,t);break;case 11:t.shift(3);break;default:t.shift(1)}}},{key:"_parseScriptData",value:function(e,i){e.data=i.shift(e.datasize);var n=(new Qe).resolve(e.data,e.data.length);this.onMetaData=n?n.onMetaData:void 0,this.emit(t.EVENTS.SCRIPT_TAG_PARSED,this.onMetaData)}},{key:"_aacSequenceHeaderParser",value:function(e){var t={hasSpecificConfig:!0};t.objectType=e[1]>>>3,t.originObjectType=t.objectType,t.sampleRateIndex=(7&e[1])<<1|e[2]>>>7,t.audiosamplerate=this._switchAudioSampleRate(t.sampleRateIndex),t.channelCount=(120&e[2])>>>3,t.frameLength=(4&e[2])>>>2,t.dependsOnCoreCoder=(2&e[2])>>>1,t.extensionFlagIndex=1&e[2];var i=window.navigator.userAgent.toLowerCase(),n=void 0,r=void 0,a=t.sampleRateIndex;return-1!==i.indexOf("firefox")?t.sampleRateIndex>=8?(t.objectType=5,r=new Array(4),n=a-3):(t.objectType=2,r=new Array(2),n=a):-1!==i.indexOf("android")||-1!==i.indexOf("safari")||-1!==i.indexOf("iphone")?(t.objectType=2,r=new Array(2),n=a):(t.objectType=5,n=t.sampleRateIndex,r=new Array(4),t.sampleRateIndex>=6?n=t.sampleRateIndex-3:1===t.channelCount&&(t.objectType=2,r=new Array(2),n=t.sampleRateIndex)),t.codec="mp4a.40."+t.objectType,r[0]=t.objectType<<3,r[0]|=(15&t.sampleRateIndex)>>>1,r[1]=(15&t.sampleRateIndex)<<7,r[1]|=(15&t.channelCount)<<3,5===t.objectType&&(r[1]|=(15&n)>>>1,r[2]=(1&n)<<7,r[2]|=8,r[3]=0),t.config=r,t}},{key:"_parseAudioTag",value:function(e,i){var n=new B,r=i.shift(1)[0];e.data=i.shift(e.datasize-1);var a=(240&r)>>>4;if(10!==a)throw new Error("invalid audio format: "+a);10===a&&(n.sampleRate=this._switchAudioSamplingFrequency(r),n.sampleRateIndex=(12&r)>>>2,n.frameLenth=(2&r)>>>1,n.channelCount=1&r,n.refSampleDuration=Math.floor(1024/n.audioSampleRate*n.timescale));var o=n.audioSampleRate,s=n.sampleRateIndex,u=n.refSampleDuration;if(0===e.data[0]){var l=this._aacSequenceHeaderParser(e.data);o=l.audiosamplerate||n.audioSampleRate,s=l.sampleRateIndex||n.sampleRateIndex,u=Math.floor(1024/o*n.timescale),n.channelCount=l.channelCount,n.sampleRate=o,n.sampleRateIndex=s,n.refSampleDuration=u,n.duration=this.onMetaData.duration*n.timescale,n.config=l.config,n.objectType=l.objectType,n.originObjectType=l.originObjectType,this.emit(t.EVENTS.AUDIO_META_PARSED,n)}else e.data=e.data.slice(1,e.data.length),this.emit(t.EVENTS.AUDIO_SAMPLE_PARSED,e)}},{key:"_parseVideoData",value:function(e,i){var n=i.shift(1)[0],r=new I(e),a=(240&n)>>>4;r.isKeyframe=1===a;var o=15&n;if(e.avcPacketType=i.shift(1)[0],r.cts=i.toInt(0,3),r.cts=r.cts<<8>>8,i.shift(3),7!==o&&12!==o)throw new Error("video codeid is "+o);var s=12===o,u=i.shift(e.datasize-5);if(0===u[4]&&0===u[5]&&0===u[6]&&1===u[7]){for(var l=0,c=0;c<4;c++)l=256*l+u[c];l-=4,(u=u.slice(4,u.length))[3]=l%256,l=(l-u[3])/256,u[2]=l%256,l=(l-u[2])/256,u[1]=l%256,u[0]=(l-u[1])/256}r.data=u;var h=void 0;if(0===e.avcPacketType)(h=s?this._hevcSequenceHeaderParser(u):this._avcSequenceHeaderParser(u)).codecID=o,this.emit(t.EVENTS.VIDEO_META_PARSED,h);else{for(var f=new g(u.buffer),d=s?ot.getHvccNals(f):rt.getAvccNals(f),p=s?[19,20,21]:[5],v=0;v<d.length;v++){var y=d[v];s?ot.analyseNal(y):rt.analyseNal(y),y.sei&&this.emit(t.EVENTS.VIDEO_SEI_PARSED,Object.assign(y.sei,{dts:e.dts})),p.indexOf(y.type)>-1&&(r.firstInGop=!0,this.gopId++)}r.gopId=this.gopId,r.nals=d,this.emit(t.EVENTS.VIDEO_SAMPLE_PARSED,r)}}},{key:"_avcSequenceHeaderParser",value:function(e){var t=0,i=new P;i.configurationVersion=e[0],i.avcProfileIndication=e[1],i.profileCompatibility=e[2],i.avcLevelIndication=e[3]/10,i.nalUnitLength=1+(3&e[4]);var n=31&e[5];t=6;for(var r={},a=0;a<n;a++){var o=255*e[t]+e[t+1];t+=2;for(var s=new Uint8Array(o),u=0;u<o;u++)s[u]=e[t+u];for(var l="avc1.",c=1;c<4;c++){var h=s[c].toString(16);h.length<2&&(h="0"+h),l+=h}i.codec=l,t+=o,i.sps=s,r=nt.parseSPS(s)}var f=e[t];t++;for(var d=0;d<f;d++){var p=255*e[t]+e[t+1];t+=2;for(var v=new Uint8Array(p),y=0;y<p;y++)v[y]=e[t+y];t+=p,i.pps=v}return Object.assign(i,nt.toVideoMeta(r)),i.duration=this.onMetaData.duration*i.timescale,i.avcc=new Uint8Array(e.length),i.avcc.set(e),i.streamType=27,i}},{key:"_hevcSequenceHeaderParser",value:function(e){var t=new P,i=0;t.configurationVersion=e[0],t.hevcProfileSpace=(192&e[1])>>>6,t.hevcTierFlag=(32&e[1])>>>5,t.hevcProfileIdc=31&e[1],t.hevcProfileCompatibilityFlags=[e[2],e[3],e[4],e[5]],t.hevcConstraintIndicatorFlags=[e[6],e[7],e[8],e[9],e[10],e[11]],t.hevcLevelIdc=e[12],t.minSpatialSegmentationIdc=e[13]&15+e[14]<<4,t.parallelismType=3&e[15],t.chromaFormat=3&e[16],t.bitDepthLumaMinus8=7&e[17],t.bitDepthChromaMinus8=7&e[18],t.avgFrameRate=256*e[19]+e[20],t.constantFrameRate=(192&e[21])>>>6,t.numTemporalLayers=(56&e[21])>>>3,t.temporalIdNested=(4&e[21])>>>2,t.lengthSizeMinusOne=3&e[21];var n=e[22];i=23;for(var r={},a=0,o=0,s=0,u=!1,l=!1,c=!1,h=void 0,f=void 0,d=void 0,p=0;p<n;p++){a=63&e[i],o=256*e[i+1]+e[i+2],i+=3;for(var v=0;v<o;v++){switch(s=256*e[i]+e[i+1],a){case 32:u||(u=!0,h=e.slice(i+2,i+2+s),t.vps=at._ebsp2rbsp(h),t.rawVps=h);break;case 33:l||(l=!0,f=e.slice(i+2,i+2+s),t.sps=at._ebsp2rbsp(f),t.rawSps=f,t.codec="hev1.1.6.L93.B0",r=at.parseSPS(f));break;case 34:c||(c=!0,d=e.slice(i+2,i+2+s),t.pps=at._ebsp2rbsp(d),t.rawPps=d)}i+=2+s}}return Object.assign(t,at.toVideoMeta(r)),t.streamType=36,t}},{key:"_switchAudioSampleRate",value:function(e){return[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350][e]}},{key:"_switchAudioSamplingFrequency",value:function(e){return[5500,11025,22050,44100,48e3][(12&e)>>>2]}},{key:"_switchAudioChannel",value:function(e){return[1,2][1&e]}},{key:"_datasizeValidator",value:function(e,t){var i=t.toInt(0,4);return t.shift(4),i===e+11}},{key:"destroy",value:function(){it(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"removeAllListeners",this).call(this)}}],[{key:"isFlvFile",value:function(e){return!(70!==e[0]||76!==e[1]||86!==e[2]||1!==e[3])}},{key:"getPlayType",value:function(e){var t={hasVideo:!1,hasAudio:!1};return!0&e&&(t.hasVideo=!0),!0&e&&(t.hasAudio=!0),t}},{key:"EVENTS",get:function(){return{FILE_HEADER_PARSED:"FILE_HEADER_PARSED",SCRIPT_TAG_PARSED:"SCRIPT_TAG_PARSED",AUDIO_META_PARSED:"AUDIO_META_PARSED",VIDEO_META_PARSED:"VIDEO_META_PARSED",VIDEO_SAMPLE_PARSED:"VIDEO_SAMPLE_PARSED",AUDIO_SAMPLE_PARSED:"AUDIO_SAMPLE_PARSED",VIDEO_SEI_PARSED:"VIDEO_SEI_PARSED"}}}]),t}($e),ut=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();var lt=d.DEMUX_EVENTS,ct=st.EVENTS,ht=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.TAG="FLV_DEMUXER",this._firstFragmentLoaded=!1,this._trackNum=0,this._hasScript=!1,this._videoMetaChange=!1,this._audioMetaChange=!1,this._hasVideoSequence=!1,this._hasAudioSequence=!1,this.demuxer=new st}return ut(e,[{key:"init",value:function(){this.on(lt.DEMUX_START,this.demux.bind(this)),this.demuxer.on(ct.FILE_HEADER_PARSED,this.handleFileHeaderParsed.bind(this)),this.demuxer.on(ct.SCRIPT_TAG_PARSED,this.handleScriptTagParsed.bind(this)),this.demuxer.on(ct.AUDIO_META_PARSED,this.handleAudioMetaParsed.bind(this)),this.demuxer.on(ct.VIDEO_META_PARSED,this.handleVideoMetaParsed.bind(this)),this.demuxer.on(ct.VIDEO_SAMPLE_PARSED,this.handleVideoSampleParsed.bind(this)),this.demuxer.on(ct.AUDIO_SAMPLE_PARSED,this.handleAudioSampleParsed.bind(this)),this.demuxer.on(ct.VIDEO_SEI_PARSED,this.handleSeiParsed.bind(this))}},{key:"handleAudioMetaParsed",value:function(e){this.tracks&&this.tracks.audioTrack&&(this._context.mediaInfo.hasAudio=!0,this.tracks.audioTrack.meta=e,this._hasAudioSequence?this.emit(lt.AUDIO_METADATA_CHANGE):this.emit(lt.METADATA_PARSED,"audio"))}},{key:"handleVideoMetaParsed",value:function(e){this.tracks&&this.tracks.videoTrack&&(this._context.mediaInfo.hasVideo=!0,this.tracks.videoTrack.meta=e,this._hasVideoSequence?this.emit(lt.VIDEO_METADATA_CHANGE):this.emit(lt.METADATA_PARSED,"video"))}},{key:"handleSeiParsed",value:function(e){this.emit(lt.SEI_PARSED,e)}},{key:"handleVideoSampleParsed",value:function(e){this.tracks&&this.tracks.videoTrack&&(e.isKeyframe&&this.emit(lt.ISKEYFRAME,e.dts+e.cts),this.tracks.videoTrack.samples.push(e))}},{key:"handleAudioSampleParsed",value:function(e){this.tracks&&this.tracks.videoTrack&&this.tracks.audioTrack.samples.push(e)}},{key:"handleScriptTagParsed",value:function(e){var t=this.videoTrack,i=this.audioTrack;if(this._context.mediaInfo.duration=e.duration,"boolean"==typeof e.hasAudio&&(this._context.mediaInfo.hsaAudio=e.hasAudio),"boolean"==typeof e.hasVideo&&(this._context.mediaInfo.hasVideo=e.hasVideo),this.emit(lt.MEDIA_INFO),this._hasScript=!0,i&&!i.hasSpecificConfig){var n=i.meta;switch(e.audiosamplerate&&(n.sampleRate=e.audiosamplerate),e.audiochannels&&(n.channelCount=e.audiochannels),e.audiosamplerate){case 44100:n.sampleRateIndex=4;break;case 22050:n.sampleRateIndex=7;break;case 11025:n.sampleRateIndex=10}}if(t&&!t.hasSpecificConfig){var r=t.meta;if("number"==typeof e.framerate){var a=Math.floor(1e3*e.framerate);if(a>0){var o=a/1e3;r.frameRate||(r.frameRate={}),r.frameRate.fixed=!0,r.frameRate.fps=o,r.frameRate.fps_num=a,r.frameRate.fps_den=1e3}}}}},{key:"handleFileHeaderParsed",value:function(e){var t=e.hasVideo,i=e.hasAudio;this._context.mediaInfo.hasVideo=t,this._context.mediaInfo.hasAudio=i,this.initVideoTrack(),this.initAudioTrack()}},{key:"demux",value:function(){if(this.loaderBuffer){try{this.demuxer.demux(this.loaderBuffer)}catch(e){}this.emit(lt.DEMUX_COMPLETE)}}},{key:"initVideoTrack",value:function(){this._trackNum++;var e=new w;e.meta=new P,e.id=e.meta.id=this._trackNum,this.tracks.videoTrack=e}},{key:"initAudioTrack",value:function(){this._trackNum++;var e=new D;e.meta=new B,e.id=e.meta.id=this._trackNum,this.tracks.audioTrack=e}},{key:"destroy",value:function(){this.demuxer&&this.demuxer.destroy()}},{key:"loaderBuffer",get:function(){var e=this._context.getInstance("LOADER_BUFFER");if(e)return e;this.emit(lt.DEMUX_ERROR,this.TAG,new Error("找不到 loaderBuffer 实例"))}},{key:"tracks",get:function(){return this._context.getInstance("TRACKS")}},{key:"logger",get:function(){return this._context.getInstance("LOGGER")}}],[{key:"getPlayType",value:function(e){var t={hasVideo:!1,hasAudio:!1};return!0&e&&(t.hasVideo=!0),!0&e&&(t.hasAudio=!0),t}}]),e}(),ft=j((function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){for(var t=0,i=arguments.length,n=Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];var a=!0,o=!1,s=void 0;try{for(var u,l=n[Symbol.iterator]();!(a=(u=l.next()).done);a=!0){var c=u.value;t+=c.length}}catch(e){o=!0,s=e}finally{try{!a&&l.return&&l.return()}finally{if(o)throw s}}var h=new e(t),f=0,d=!0,p=!1,v=void 0;try{for(var y,_=n[Symbol.iterator]();!(d=(y=_.next()).done);d=!0){var m=y.value;h.set(m,f),f+=m.length}}catch(e){p=!0,v=e}finally{try{!d&&_.return&&_.return()}finally{if(p)throw v}}return h}}));F(ft);var dt=F(j((function(e){var t,i=(t=ft)&&t.__esModule?t:{default:t};e.exports=i.default}))),pt=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();var vt=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.buffer=t||new Uint8Array(0)}return pt(e,[{key:"write",value:function(){for(var e=this,t=arguments.length,i=Array(t),n=0;n<t;n++)i[n]=arguments[n];i.forEach((function(t){e.buffer=dt(Uint8Array,e.buffer,t)}))}}],[{key:"writeUint32",value:function(e){return new Uint8Array([e>>24,e>>16&255,e>>8&255,255&e])}},{key:"readAsInt",value:function(e){var t="";return e.forEach((function(e){t+=e.toString(16).padStart(2,"0")})),parseInt(t,16)}}]),e}(),yt=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();var _t=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return yt(e,null,[{key:"size",value:function(e){return vt.writeUint32(e)}},{key:"initBox",value:function(t,i){for(var n=new vt,r=arguments.length,a=Array(r>2?r-2:0),o=2;o<r;o++)a[o-2]=arguments[o];return n.write.apply(n,[e.size(t),e.type(i)].concat(a)),n.buffer}},{key:"extension",value:function(e,t){return new Uint8Array([e,t>>16&255,t>>8&255,255&t])}},{key:"ftyp",value:function(){return e.initBox(24,"ftyp",new Uint8Array([105,115,111,109,0,0,0,1,105,115,111,109,97,118,99,49]))}},{key:"ftypHEVC",value:function(){return e.initBox(24,"ftyp",new Uint8Array([105,115,111,109,0,0,0,1,105,115,111,109,100,97,115,104]))}},{key:"moov",value:function(t){var i=t.type,n=t.meta,r=8,a=e.mvhd(n.duration,n.timescale),o=void 0;o="video"===i?e.videoTrak(n):e.audioTrak(n);var s=e.mvex(n.duration,n.timescale||1e3,n.id);return[a,o,s].forEach((function(e){r+=e.byteLength})),e.initBox(r,"moov",a,o,s)}},{key:"mvhd",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3,n=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,i>>>24&255,i>>>16&255,i>>>8&255,255&i,t>>>24&255,t>>>16&255,t>>>8&255,255&t,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return e.initBox(8+n.length,"mvhd",new Uint8Array(n))}},{key:"videoTrak",value:function(t){var i=8,n=e.tkhd({id:1,duration:t.duration,timescale:t.timescale||1e3,width:t.presentWidth,height:t.presentHeight,type:"video"}),r=e.mdia({type:"video",timescale:t.timescale||1e3,duration:t.duration,avcc:t.avcc,parRatio:t.parRatio,width:t.presentWidth,height:t.presentHeight,streamType:t.streamType});return[n,r].forEach((function(e){i+=e.byteLength})),e.initBox(i,"trak",n,r)}},{key:"audioTrak",value:function(t){var i=8,n=e.tkhd({id:2,duration:t.duration,timescale:t.timescale||1e3,width:0,height:0,type:"audio"}),r=e.mdia({type:"audio",timescale:t.timescale||1e3,duration:t.duration,channelCount:t.channelCount,samplerate:t.sampleRate,config:t.config});return[n,r].forEach((function(e){i+=e.byteLength})),e.initBox(i,"trak",n,r)}},{key:"tkhd",value:function(t){var i=t.id,n=t.duration,r=t.width,a=t.height,o=new Uint8Array([0,0,0,7,0,0,0,0,0,0,0,0,i>>>24&255,i>>>16&255,i>>>8&255,255&i,0,0,0,0,n>>>24&255,n>>>16&255,n>>>8&255,255&n,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,r>>>8&255,255&r,0,0,a>>>8&255,255&a,0,0]);return e.initBox(8+o.byteLength,"tkhd",o)}},{key:"edts",value:function(t){var i=new vt,n=t.duration,r=t.mediaTime;return i.write(e.size(36),e.type("edts")),i.write(e.size(28),e.type("elst")),i.write(new Uint8Array([0,0,0,1,n>>24&255,n>>16&255,n>>8&255,255&n,r>>24&255,r>>16&255,r>>8&255,255&r,0,0,0,1])),i.buffer}},{key:"mdia",value:function(t){var i=8,n=e.mdhd(t.timescale,t.duration),r=e.hdlr(t.type),a=e.minf(t);return[n,r,a].forEach((function(e){i+=e.byteLength})),e.initBox(i,"mdia",n,r,a)}},{key:"mdhd",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3,i=arguments[1],n=new Uint8Array([0,0,0,0,0,0,0,0,t>>>24&255,t>>>16&255,t>>>8&255,255&t,i>>>24&255,i>>>16&255,i>>>8&255,255&i,85,196,0,0]);return e.initBox(12+n.byteLength,"mdhd",e.extension(0,0),n)}},{key:"hdlr",value:function(t){var i=[0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0];return"audio"===t&&(i.splice.apply(i,[8,4].concat([115,111,117,110])),i.splice.apply(i,[24,13].concat([83,111,117,110,100,72,97,110,100,108,101,114,0]))),e.initBox(8+i.length,"hdlr",new Uint8Array(i))}},{key:"minf",value:function(t){var i=8,n="video"===t.type?e.vmhd():e.smhd(),r=e.dinf(),a=e.stbl(t);return[n,r,a].forEach((function(e){i+=e.byteLength})),e.initBox(i,"minf",n,r,a)}},{key:"vmhd",value:function(){return e.initBox(20,"vmhd",new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]))}},{key:"smhd",value:function(){return e.initBox(16,"smhd",new Uint8Array([0,0,0,0,0,0,0,0]))}},{key:"dinf",value:function(){var t=new vt;return t.write(e.size(36),e.type("dinf"),e.size(28),e.type("dref"),new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1])),t.buffer}},{key:"stbl",value:function(t){var i=8,n=e.stsd(t),r=e.stts(),a=e.stsc(),o=e.stsz(),s=e.stco();return[n,r,a,o,s].forEach((function(e){i+=e.byteLength})),e.initBox(i,"stbl",n,r,a,o,s)}},{key:"stsd",value:function(t){var i=void 0;return i="audio"===t.type?e.mp4a(t):36===t.streamType?e.hvc1(t):e.avc1(t),e.initBox(16+i.byteLength,"stsd",e.extension(0,0),new Uint8Array([0,0,0,1]),i)}},{key:"mp4a",value:function(t){var i=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channelCount,0,16,0,0,0,0,t.samplerate>>8&255,255&t.samplerate,0,0]),n=e.esds(t.config);return e.initBox(8+i.byteLength+n.byteLength,"mp4a",i,n)}},{key:"esds",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[43,146,8,0],i=t.length,n=new vt,r=new Uint8Array([0,0,0,0,3,23+i,0,1,0,4,15+i,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([i]).concat(t).concat([6,1,2]));return n.write(e.size(8+r.byteLength),e.type("esds"),r),n.buffer}},{key:"avc1",value:function(t){var i=new vt,n=t.width,r=t.height,a=t.parRatio.width,o=t.parRatio.height,s=t.avcc,u=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,n>>8&255,255&n,r>>8&255,255&r,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),l=new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192]),c=new Uint8Array([a>>24,a>>16&255,a>>8&255,255&a,o>>24,o>>16&255,o>>8&255,255&o]);return i.write(e.size(40+u.byteLength+s.byteLength+l.byteLength),e.type("avc1"),u,e.size(8+s.byteLength),e.type("avcC"),s,e.size(20),e.type("btrt"),l,e.size(16),e.type("pasp"),c),i.buffer}},{key:"hvc1",value:function(t){var i=new vt,n=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,t.width>>8&255,255&t.width,t.height>>8&255,255&t.height,0,72,0,0,0,72,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,255,255,0,0,0,122,104,118,99,67,1,1,96,0,0,0,144,0,0,0,0,0,93,240,0,252,253,248,248,0,0,15,3,160,0,1,0,24,64,1,12,1,255,255,1,96,0,0,3,0,144,0,0,3,0,0,3,0,93,153,152,9,161,0,1,0,45,66,1,1,1,96,0,0,3,0,144,0,0,3,0,0,3,0,93,160,2,128,128,45,22,89,153,164,147,43,154,128,128,128,130,0,0,3,0,2,0,0,3,0,50,16,162,0,1,0,7,68,1,193,114,180,98,64]);return i.write(e.size(8+n.byteLength+10),e.type("hvc1"),n,e.size(10),e.type("fiel"),new Uint8Array([1,0])),i.buffer}},{key:"stts",value:function(){var t=new Uint8Array([0,0,0,0,0,0,0,0]);return e.initBox(16,"stts",t)}},{key:"stsc",value:function(){var t=new Uint8Array([0,0,0,0,0,0,0,0]);return e.initBox(16,"stsc",t)}},{key:"stco",value:function(){var t=new Uint8Array([0,0,0,0,0,0,0,0]);return e.initBox(16,"stco",t)}},{key:"stsz",value:function(){var t=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]);return e.initBox(20,"stsz",t)}},{key:"mvex",value:function(t){var i=arguments[2],n=new vt,r=vt.writeUint32(t);return n.write(e.size(56),e.type("mvex"),e.size(16),e.type("mehd"),e.extension(0,0),r,e.trex(i)),n.buffer}},{key:"trex",value:function(t){var i=new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]);return e.initBox(8+i.byteLength,"trex",i)}},{key:"moof",value:function(t){var i=8,n=e.mfhd(),r=e.traf(t);return[n,r].forEach((function(e){i+=e.byteLength})),e.initBox(i,"moof",n,r)}},{key:"mfhd",value:function(){var t=vt.writeUint32(e.sequence);return e.sequence+=1,e.initBox(16,"mfhd",e.extension(0,0),t)}},{key:"traf",value:function(t){var i=8,n=e.tfhd(t.id),r=e.tfdt(t.time),a=e.sdtp(t),o=e.trun(t,a.byteLength);return[n,r,o,a].forEach((function(e){i+=e.byteLength})),e.initBox(i,"traf",n,r,o,a)}},{key:"tfhd",value:function(t){var i=vt.writeUint32(t);return e.initBox(16,"tfhd",e.extension(0,0),i)}},{key:"tfdt",value:function(t){return e.initBox(16,"tfdt",e.extension(0,0),vt.writeUint32(t))}},{key:"trun",value:function(t,i){var n=new vt,r=vt.writeUint32(t.samples.length),a=vt.writeUint32(92+16*t.samples.length+i);return n.write(e.size(20+16*t.samples.length),e.type("trun"),new Uint8Array([0,0,15,1]),r,a),t.samples.forEach((function(e){var t=e.flags;n.write(new Uint8Array([e.duration>>>24&255,e.duration>>>16&255,e.duration>>>8&255,255&e.duration,e.size>>>24&255,e.size>>>16&255,e.size>>>8&255,255&e.size,t.isLeading<<2|t.dependsOn,t.isDependedOn<<6|t.hasRedundancy<<4|t.isNonSync,0,0,e.cts>>>24&255,e.cts>>>16&255,e.cts>>>8&255,255&e.cts]))})),n.buffer}},{key:"sdtp",value:function(t){var i=new vt;return i.write(e.size(12+t.samples.length),e.type("sdtp"),e.extension(0,0)),t.samples.forEach((function(e){var t=e.flags,n=t.isLeading<<6|t.dependsOn<<4|t.isDependedOn<<2|t.hasRedundancy;i.write(new Uint8Array([n]))})),i.buffer}},{key:"mdat",value:function(t){var i=new vt,n=8;t.samples.forEach((function(e){n+=e.size})),i.write(e.size(n),e.type("mdat"));var r=new Uint8Array(n),a=0;return r.set(i.buffer,a),a+=8,t.samples.forEach((function(e){e.buffer.forEach((function(e){r.set(e,a),a+=e.byteLength}))})),r}}]),e}();_t.type=function(e){return new Uint8Array([e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)])},_t.sequence=1;var mt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},gt=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();var Et=function(e){function t(e){var i=e.videoMeta,n=e.audioMeta,r=e.curTime;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var a=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==(void 0===t?"undefined":mt(t))&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return a.TAG="Fmp4Remuxer",a._dtsBase=1e3*r,a._videoMeta=i,a._audioMeta=n,a._audioDtsBase=null,a._videoDtsBase=null,a._isDtsBaseInited=!1,a.isFirstVideo=!0,a.isFirstAudio=!0,a.videoAllDuration=0,a.audioAllDuration=0,a.audioRemuxed=0,a.videoRemuxed=0,a.mp4Durations={keys:[]},a}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":mt(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),gt(t,[{key:"destroy",value:function(){this._dtsBase=-1,this._isDtsBaseInited=!1,this.mp4Durations={keys:[]},this.removeAllListeners()}},{key:"remux",value:function(e,t){!this._isDtsBaseInited&&this.calcDtsBase(e,t),this.remuxVideo(t),this.remuxAudio(e),ce.groupEnd()}},{key:"resetDtsBase",value:function(){this._dtsBase=0}},{key:"seek",value:function(e){ce.log(this.TAG,"set dtsBase for seek(),time=",e),this._isDtsBaseInited?(this._isDtsBaseInited=!1,this._dtsBase=1e3*e):this._dtsBase=1e3*e,this._audioDtsBase=this._videoDtsBase=null}},{key:"remuxInitSegment",value:function(e,t){ce.log(this.TAG,"remuxInitSegment: type=",e);var i=new vt,n=36===t.streamType?_t.ftypHEVC():_t.ftyp(),r=_t.moov({type:e,meta:t});return i.write(n,r),i}},{key:"calcDtsBase",value:function(e,t){if(!e&&t.samples.length){var i=t.samples[0],n=void 0;return i.options&&i.options.start&&(n=i.options.start),this._videoDtsBase=i.dts-(n||this._dtsBase),void(this._isDtsBaseInited=!0)}if(e&&e.samples.length||t&&t.samples.length){var r=null,a=null,o=null;if(e&&e.samples&&e.samples.length){var s=e.samples[0];r=s.dts,s.options&&s.options.start&&(o=s.options.start)}if(t&&t.samples&&t.samples.length){var u=t.samples[0];a=u.dts,u.options&&u.options.start&&(o=u.options.start)}var l=r-a;r&&l<0&&null!==o&&t.samples.forEach((function(e){e.dts-=l,e.pts&&(e.pts-=l)})),this._videoDtsBase=(a||r)-(o||this._dtsBase),this._audioDtsBase=(r||a)-(o||this._dtsBase),this._dtsBase=Math.min(a,r),this._isDtsBaseInited=!0,ce.log(this.TAG,"calcDtsBase"),ce.log(this.TAG,"video first dts: "+a+" , start:"+o+" , _videoDtsBase:"+this._videoDtsBase+" , _dtsBase:"+this._dtsBase),ce.log(this.TAG,"audio first dts: "+r+" , start:"+o+" , _audioDtsBase:"+this._audioDtsBase+", _dtsBase:"+this._dtsBase)}}},{key:"remuxVideo",value:function(e){var i=this,n=e||{};if(e&&e.samples&&e.samples.length){var r=n.samples;if(n.meta){for(var a=-1,o=null,s=[],u={samples:[]},l=1e4;r.length&&l-- >0;){var c=r.shift(),h=c.isKeyframe,f=c.options;if(!this.isFirstVideo&&f&&f.meta){o=this.remuxInitSegment("video",f.meta),f.meta=null,r.unshift(c),f.isContinue||(this._videoDtsBase=0);break}var d=Math.max(0,c.dts-this.videoDtsBase);-1===a&&(a=d);var p=void 0,v=void 0;void 0!==c.pts&&(p=(v=c.pts-this._dtsBase)-d),void 0!==c.cts&&(v=c.cts+d,p=c.cts);var y={buffer:[],size:0},_=0;if(c.duration)_=c.duration;else if(r.length>=1){_=r[0].dts-this.videoDtsBase-d}else _=s.length>=1?s[s.length-1].duration:this._videoMeta.refSampleDuration;this.videoAllDuration+=_,ce.long&&ce.log(this.TAG,"video dts "+d,"pts "+v,"cts: "+p,h,"originDts "+c.originDts,"duration "+_),_>=0&&(u.samples.push(y),y.buffer.push(c.data),y.size+=c.data.byteLength,s.push({dts:d,cts:p,pts:v,data:c.data,size:c.data.byteLength,isKeyframe:h,duration:_,flags:{isLeading:0,dependsOn:h?2:1,isDependedOn:h?1:0,hasRedundancy:0,isNonSync:h?0:1},originDts:d,type:"video"}),this.mp4Durations[v]=_,this.mp4Durations.keys.push(v)),h&&this.emit(t.EVENTS.RANDOM_ACCESS_POINT,v)}if(this.mp4Durations.keys.length>1e4){var m=this.mp4Durations;this.mp4Durations={},this.mp4Durations.keys=m.keys.slice(-100),this.mp4Durations.keys.forEach((function(e){i.mp4Durations[e]=m[e]}))}s.length&&ce.log(this.TAG,"remux to mp4 video:",[a/1e3,s[s.length-1].dts/1e3]);var g=new vt;if(s.length&&n.meta){var E=_t.moof({id:n.meta.id,time:a,samples:s}),b=_t.mdat(u);g.write(E,b),this.segmentRemuxed("video",g,s[s.length-1].pts-s[0].pts)}if(o&&(this.segmentRemuxed("video",o),r.length))return n.samples=r,this.remuxVideo(n);this.isFirstVideo=!1,this.emit(t.EVENTS.TRACK_REMUXED,"video",g),n.samples=[],n.length=0}}}},{key:"remuxAudio",value:function(e){var i=(e||{}).samples,n=-1,r=[],a=null,o={samples:[]};if(i&&i.length){for(var s=1e4,u=!1;i.length&&s-- >0;){var l=i.shift(),c=l.data,h=l.options;if(!this.isFirstAudio&&h&&h.meta){a=this.remuxInitSegment("audio",h.meta),h.meta=null,i.unshift(l),h.isContinue||(this._audioDtsBase=0);break}var f=Math.max(0,l.dts-this.audioDtsBase),d=l.originDts;u||(n=f,u=!0);var p=0;if(l.duration)p=l.duration;else if(this._audioMeta.refSampleDurationFixed)p=this._audioMeta.refSampleDurationFixed;else if(i.length>=1){p=i[0].dts-this.audioDtsBase-f}else p=r.length>=1?r[r.length-1].duration:this._audioMeta.refSampleDuration;this.audioAllDuration+=p;var v={dts:f,pts:f,cts:0,size:c.byteLength,duration:l.duration?l.duration:p,flags:{isLeading:0,dependsOn:1,isDependedOn:0,hasRedundancy:0,isNonSync:0},isKeyframe:!0,originDts:d,type:"audio"},y={buffer:[],size:0};p>=0&&(y.buffer.push(c),y.size+=c.byteLength,o.samples.push(y),r.push(v))}var _=new vt;if(r.length&&e.meta){ce.log(this.TAG,"remux to mp4 audio:",[n/1e3,r[r.length-1].dts/1e3]);var m=_t.moof({id:e.meta.id,time:n,samples:r}),g=_t.mdat(o);_.write(m,g),this.segmentRemuxed("audio",_,r[r.length-1].dts-r[0].dts)}if(a&&(this.segmentRemuxed("audio",a),i.length))return e.samples=i,this.remuxAudio(e);this.isFirstAudio=!1,this.emit(t.EVENTS.TRACK_REMUXED,"audio",_),e.samples=[],e.length=0}}},{key:"segmentRemuxed",value:function(e,i,n){this.emit(t.EVENTS.MEDIA_SEGMENT,e,i,n)}},{key:"videoDtsBase",get:function(){return null!==this._videoDtsBase?this._videoDtsBase:this._dtsBase},set:function(e){this._videoDtsBase=e}},{key:"audioDtsBase",get:function(){return null!==this._audioDtsBase?this._audioDtsBase:this._dtsBase}}],[{key:"EVENTS",get:function(){return{MEDIA_SEGMENT:"MEDIA_SEGMENT",INIT_SEGMENT:"INIT_SEGMENT",RANDOM_ACCESS_POINT:"RANDOM_ACCESS_POINT",TRACK_REMUXED:"TRACK_REMUXED"}}}]),t}($e),bt=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();function kt(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var At=d.REMUX_EVENTS,St=d.PLAYER_EVENTS,Tt=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;kt(this,e),this.TAG="Mp4Remuxer",this._curTime=t,this.remuxer||this.initRemuxer()}return bt(e,[{key:"init",value:function(){this.on(At.REMUX_MEDIA,this.remux.bind(this)),this.on(At.REMUX_METADATA,this.onMetaDataReady.bind(this)),this.on(At.DETECT_CHANGE_STREAM,this.resetDtsBase.bind(this)),this.on(At.DETECT_FRAG_ID_DISCONTINUE,this.seek.bind(this)),this.on(St.SEEK,this.seek.bind(this))}},{key:"initRemuxer",value:function(){this.remuxer=new Et({audioMeta:null,videoMeta:null,curTime:this._curTime}),this.remuxer.on(Et.EVENTS.MEDIA_SEGMENT,this.writeToSource.bind(this)),this.remuxer.on(Et.EVENTS.TRACK_REMUXED,this.onTrackRemuxed.bind(this))}},{key:"remux",value:function(){this.remuxer._videoMeta||(this.remuxer._videoMeta=this.videoMeta,this.remuxer._audioMeta=this.audioMeta);var e=this._context.getInstance("TRACKS"),t=e.audioTrack,i=e.videoTrack;return this.remuxer.remux(t,i)}},{key:"resetDtsBase",value:function(){this.remuxer&&this.remuxer.resetDtsBase()}},{key:"seek",value:function(e){this.remuxer&&this.remuxer.seek(e)}},{key:"onMetaDataReady",value:function(e){this.remuxer||this.initRemuxer();var t=void 0;"audio"===e?t=this._context.getInstance("TRACKS").audioTrack:t=this._context.getInstance("TRACKS").videoTrack;var i=this._context.getInstance("PRE_SOURCE_BUFFER"),n=i.getSource(e);n||(n=i.createSource(e)),n.mimetype=t.meta.codec,n.init=this.remuxer.remuxInitSegment(e,t.meta),this.emit(At.INIT_SEGMENT,e)}},{key:"onTrackRemuxed",value:function(e){this.emit(At.MEDIA_SEGMENT,e)}},{key:"writeToSource",value:function(e,t,i){var n=this._context.getInstance("PRE_SOURCE_BUFFER"),r=n.getSource(e);r||(r=n.createSource(e)),r.data.push(t),i&&(r.bufferDuration=i+(r.bufferDuration||0))}},{key:"destroy",value:function(){this.remuxer&&this.remuxer.destroy(),this.remuxer=null}},{key:"videoMeta",get:function(){return this._context.getInstance("TRACKS").videoTrack.meta}},{key:"audioMeta",get:function(){return this._context.getInstance("TRACKS").audioTrack.meta}}]),e}(),Dt=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();function wt(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var Rt=d.REMUX_EVENTS,Ot=d.DEMUX_EVENTS,Lt=d.LOADER_EVENTS,xt=d.MSE_EVENTS,Bt="FLVController",Pt=function(){function e(){wt(this,e)}return Dt(e,[{key:"warn",value:function(){}}]),e}(),Ct=function(){function e(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0;wt(this,e),this.TAG=Bt,this.state={initSegmentArrived:!1,randomAccessPoints:[]},this.configs=Object.assign({retryTimes:3},i),this.mse=n,this.bufferClearTimer=null,this._handleTimeUpdate=this._handleTimeUpdate.bind(this)}return Dt(e,[{key:"init",value:function(){this.mse||(this.mse=new $({container:this._player.video},this._context),this.mse.init()),this.initComponents(),this.initListeners()}},{key:"initComponents",value:function(){this._context.registry("FETCH_LOADER",ue),this._context.registry("LOADER_BUFFER",O),this._context.registry("FLV_DEMUXER",ht),this._context.registry("TRACKS",T),this._context.registry("MP4_REMUXER",Tt)(this._player.currentTime),this._context.registry("PRE_SOURCE_BUFFER",_),!1!==this._player.config.compatibility&&this._context.registry("COMPATIBILITY",Ve),this._context.registry("LOGGER",Pt)}},{key:"initListeners",value:function(){this.on(Lt.LOADER_DATALOADED,this._handleLoaderDataLoaded.bind(this)),this.on(Lt.LOADER_ERROR,this._handleNetworkError.bind(this)),this.on(Lt.LOADER_RETRY,this._handleFetchRetry.bind(this)),this.on(Ot.MEDIA_INFO,this._handleMediaInfo.bind(this)),this.on(Ot.METADATA_PARSED,this._handleMetadataParsed.bind(this)),this.on(Ot.DEMUX_COMPLETE,this._handleDemuxComplete.bind(this)),this.on(Ot.DEMUX_ERROR,this._handleDemuxError.bind(this)),this.on(Ot.SEI_PARSED,this._handleSEIParsed.bind(this)),this.on(Rt.INIT_SEGMENT,this._handleAppendInitSegment.bind(this)),this.on(Rt.MEDIA_SEGMENT,this._handleMediaSegment.bind(this)),this.on(Rt.RANDOM_ACCESS_POINT,this._handleAddRAP.bind(this)),this.on(Rt.REMUX_ERROR,this._handleRemuxError.bind(this)),this.on(xt.SOURCE_UPDATE_END,this._handleSourceUpdateEnd.bind(this)),this.on(xt.MSE_ERROR,this._handleMseError.bind(this)),this._player.on("timeupdate",this._handleTimeUpdate)}},{key:"_handleMediaInfo",value:function(){this._context.mediaInfo||this.emit(Ot.DEMUX_ERROR,new Error("failed to get mediainfo"))}},{key:"_handleLoaderDataLoaded",value:function(){this.emitTo("FLV_DEMUXER",Ot.DEMUX_START)}},{key:"_handleMetadataParsed",value:function(e){this.emit(Rt.REMUX_METADATA,e)}},{key:"_handleSEIParsed",value:function(e){this._player.emit("SEI_PARSED",e)}},{key:"_handleDemuxComplete",value:function(){this.emit(Rt.REMUX_MEDIA,"flv")}},{key:"_handleRemuxError",value:function(e,t,i){void 0===i&&(i=!1),this._player.emit("error",{errorType:"parse",ex:"["+e+"]: "+t.message,errd:{}}),this._onError(Rt.REMUX_ERROR,e,t,i)}},{key:"_handleAppendInitSegment",value:function(){this.state.initSegmentArrived=!0,this.mse.addSourceBuffers()}},{key:"_handleMediaSegment",value:function(){this.mse.addSourceBuffers(),this.mse.doAppend()}},{key:"_handleSourceUpdateEnd",value:function(){var e=this._player.currentTime,t=this._player.video,i=this._player.config.preloadTime||5,n=t.buffered.length;if(0!==n){var r=t.buffered.end(n-1);r-e>2*i&&!this._player.paused&&(this._player.currentTime=r-i),this.mse.doAppend(),this._player.paused&&this._handleTimeUpdate()}}},{key:"_handleTimeUpdate",value:function(){var e=this,t=this._player.currentTime,i=this._player.video,n=i.buffered;if(n&&n.length){var r=[0,0],a=i.currentTime;if(n)for(var o=0,s=n.length;o<s&&(r[0]=n.start(o),r[1]=n.end(o),!(r[0]<=a&&a<=r[1]));o++);var u=r[0],l=r[1];if(a<u)i.currentTime=u;else if(t-u>10||n.length>1){if(this.bufferClearTimer||!this.state.randomAccessPoints.length)return;for(var c=1/0,h=0;h<this.state.randomAccessPoints.length;h++){var f=Math.ceil(this.state.randomAccessPoints[h]/1e3);if(f>t-10)break;c=f}this.mse.remove(Math.max(Math.min(c-1,t-10,l-10),.1),0),this.bufferClearTimer=setTimeout((function(){e.bufferClearTimer=null}),5e3)}}}},{key:"_handleNetworkError",value:function(e,t){this._player.emit("error",{code:t.code,errorType:"network",ex:"["+e+"]: "+t.message,errd:{}}),this._onError(Lt.LOADER_ERROR,e,t,!0)}},{key:"_handleFetchRetry",value:function(e,t){this._player.emit("retry",Object.assign({tag:e},t))}},{key:"_handleDemuxError",value:function(e,t,i){void 0===i&&(i=!1),this._player.emit("error",{errorType:"parse",ex:"["+e+"]: "+t.message,errd:{}}),this._onError(Ot.DEMUX_ERROR,e,t,i)}},{key:"_handleMseError",value:function(e,t,i){void 0===i&&(i=!1),this._onError(xt.MSE_ERROR,e,t,i)}},{key:"_handleAddRAP",value:function(e){this.state.randomAccessPoints&&this.state.randomAccessPoints.push(e)}},{key:"_onError",value:function(e,t,i,n){var r={errorType:e,errorDetails:"["+t+"]: "+(i?i.message:""),errorFatal:n||!1};this._player.emit("FLV_ERROR",r)}},{key:"seek",value:function(){this.state.initSegmentArrived||this.loadData()}},{key:"loadData",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._player.config.url,t=this._player.config.retry||{},i=t.count,n=t.delay;this.emit(Lt.LADER_START,e,{},i,n)}},{key:"pause",value:function(){var e=this._context.getInstance("FETCH_LOADER");e&&e.cancel()}},{key:"destroy",value:function(){this._player.off("timeupdate",this._handleTimeUpdate),this.mse=null,this.state.randomAccessPoints=[]}}]),e}(),Mt={Mp4Remuxer:Tt,FlvDemuxer:ht,FetchLoader:ue,Tracks:T,RemuxedBufferManager:_,XgBuffer:O,Compatibility:Ve,Mse:$},It="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Ut=function e(t,i,n){null===t&&(t=Function.prototype);var r=Object.getOwnPropertyDescriptor(t,i);if(void 0===r){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,i,n)}if("value"in r)return r.value;var o=r.get;return void 0!==o?o.call(n):void 0},Vt=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();var Nt=d.FlvAllowedEvents,Gt=function(t){function i(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,i);var t=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==(void 0===t?"undefined":It(t))&&"function"!=typeof t?e:t}(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e));return t.config=Object.assign({},Mt,t.config),t.initEvents(),t.loaderCompleteTimer=null,t.hasPlayed=!1,t}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":It(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(i,t),Vt(i,null,[{key:"isSupported",value:function(){return window.MediaSource&&window.MediaSource.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"')}},{key:"install",value:function(t,i){return e.install(t,i)}}]),Vt(i,[{key:"start",value:function(){this.started||(this.context&&this.context.destroy(),this.context=new q(this,this.config,Nt),this.initFlv(),this.context.init(),Ut(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"start",this).call(this,this.flv.mse.url),this.loadData(),this.started=!0)}},{key:"initFlvEvents",value:function(t){var i=this,n=this;t.once(d.REMUX_EVENTS.INIT_SEGMENT,(function(){e.util.addClass(n.root,"xgplayer-is-live")})),t.on(d.LOADER_EVENTS.LOADER_COMPLETE,(function(){if(n.paused)n.emit("ended");else if(i.video){var e=i.getBufferedRange()[1]-i.currentTime;setTimeout((function(){i.emit("ended")}),1e3*e)}}))}},{key:"initFlvBackupEvents",value:function(e,t){var n=this,r=3;e.on(d.REMUX_EVENTS.MEDIA_SEGMENT,(function(){0===(r-=1)&&(n.flv=e,n.mse.resetContext(t),n.context.destroy(),n.context=t,n.paused&&Ut(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"play",n).call(n))})),e.once(d.LOADER_EVENTS.LOADER_COMPLETE,(function(){if(n.paused)n.emit("ended");else if(n.video){var e=n.getBufferedRange()[1]-n.currentTime;setTimeout((function(){n.emit("ended")}),1e3*e)}})),e.once(d.LOADER_EVENTS.LOADER_ERROR,(function(){t.destroy()}))}},{key:"initEvents",value:function(){var e=this;this.on("seeking",(function(){var t=e.currentTime,i=e.getBufferedRange();(t>i[1]||t<i[0])&&e.flv.seek(e.currentTime)})),this.once("play",(function(){e.hasPlayed=!0}))}},{key:"initFlv",value:function(){var e=this.context.registry("FLV_CONTROLLER",Ct)(this,{retryTimes:this.config.retryTimes});return this.initFlvEvents(e),this.flv=e,this.mse=e.mse,e}},{key:"play",value:function(){var e=this;return this.paused&&this.hasPlayed?this.mse.cleanBuffers().then((function(){return e.started=!1,e.start(),Ut(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"play",e).call(e)})):(this.hasPlayed=!0,Ut(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"play",this).call(this))}},{key:"pause",value:function(){Ut(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"pause",this).call(this),this.flv&&(this.flv.pause(),this.hasPlayed=!0)}},{key:"loadData",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.currentTime;this.flv&&this.flv.seek(e)}},{key:"destroy",value:function(){var e=this,t=new Promise((function(t){e._destroy().then(t).catch(t),setTimeout((function(){t()}),50)}));return Ut(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"destroy",this).call(this),t}},{key:"_destroy",value:function(){var e=this;this.context&&this.context.destroy(),this.newContext&&this.newContext.destroy();var t=function(){e.flv=null,e.context=null,e.newFlv=null,e.newContext=null};return this.flv&&this.flv.mse?this.flv.mse.destroy().then((function(){t()})):Promise.resolve().then((function(){t()}))}},{key:"switchURL",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];t||(this.pause(),this.context.destroy());var i=new q(this,this.config,Nt),n=i.registry("FLV_CONTROLLER",Ct)(this,{retryTimes:this.config.retryTimes},this.mse);this.newContext=i,this.newFlv=n,i.init(),this.initFlvBackupEvents(n,i),n.loadData(e)}},{key:"src",get:function(){return this.currentSrc},set:function(e){this.switchURL(e)}},{key:"core",get:function(){return this.flv}}]),i}(e),Ft=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();var jt=Ae,Ht=Ce,zt=d.DEMUX_EVENTS,Xt=d.LOADER_EVENTS,Wt=function(){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),this.TAG="FLVController",this.state={initSegmentArrived:!1,randomAccessPoints:[]},this.bufferClearTimer=null}return Ft(t,[{key:"init",value:function(){this.initComponents(),this.initListeners()}},{key:"initComponents",value:function(){var e=this._player.config,t=e.FetchLoader,i=e.XgBuffer,n=e.FlvDemuxer,r=e.Tracks,a=e.Logger;this._context.registry("FETCH_LOADER",t),this._context.registry("LOADER_BUFFER",i),this._context.registry("FLV_DEMUXER",n),this._context.registry("TRACKS",r),this._context.registry("LOGGER",a)}},{key:"initListeners",value:function(){this.on(Xt.LOADER_DATALOADED,this._handleLoaderDataLoaded.bind(this)),this.on(Xt.LOADER_ERROR,this._handleNetworkError.bind(this)),this.on(zt.MEDIA_INFO,this._handleMediaInfo.bind(this)),this.on(zt.METADATA_PARSED,this._handleMetadataParsed.bind(this)),this.on(zt.DEMUX_COMPLETE,this._handleDemuxComplete.bind(this)),this.on(zt.DEMUX_ERROR,this._handleDemuxError.bind(this)),this.on(zt.SEI_PARSED,this._handleSEIParsed.bind(this))}},{key:"_handleMediaInfo",value:function(){this._context.mediaInfo?this._player.video&&this._player.video.handleMediaInfo():this.emit(zt.DEMUX_ERROR,new Error("failed to get mediainfo"))}},{key:"_handleLoaderDataLoaded",value:function(){this.emitTo("FLV_DEMUXER",zt.DEMUX_START)}},{key:"_handleSEIParsed",value:function(e){this._player.emit("SEI_PARSED",e)}},{key:"_handleDemuxComplete",value:function(){var e=this;if(this._player.video){var t=this._context.getInstance("TRACKS"),i=t.videoTrack,n=t.audioTrack;i.samples.forEach((function(t){if(!t.analyzed){t.analyzed=!0;var n=new g(t.data.buffer),r=void 0,a=(r=e._isHEVC(i.meta)?Ht.getHvccNals(n):jt.getNalunits(n)).reduce((function(e,t){return e+4+t.body.byteLength}),0),o=new Uint8Array(a),s=0;r.forEach((function(e){o.set([0,0,0,1],s),s+=4,o.set(new Uint8Array(e.body),s),s+=e.body.byteLength})),t.data=o}})),this._player.video.onDemuxComplete(i,n)}}},{key:"_handleVisibilityChange",value:function(e){var t=!e;t||this._player.paused?t&&this._player.paused&&this._player.play():this._player.pause()}},{key:"_handleMetadataParsed",value:function(e){if("audio"===e){var t=this._context.getInstance("TRACKS").audioTrack;t&&t.meta&&this._setMetaToAudio(t.meta)}else{var i=this._context.getInstance("TRACKS").videoTrack;i&&i.meta&&this._setMetaToVideo(i.meta)}}},{key:"_setMetaToAudio",value:function(e){this._player.video&&this._player.video.setAudioMeta(e)}},{key:"_setMetaToVideo",value:function(e){this._player.video&&this._player.video.setVideoMeta(e)}},{key:"_handleAppendInitSegment",value:function(){this.state.initSegmentArrived=!0}},{key:"_handleNetworkError",value:function(t,i){this._player.emit("error",new e.Errors("network",this._player.config.url)),this._onError(Xt.LOADER_ERROR,t,i,!0,"MEDIA_ERR_NETWORK")}},{key:"_handleDemuxError",value:function(t,i,n){void 0===n&&(n=!1),this._player.emit("error",new e.Errors("parse",this._player.config.url)),this._onError(zt.DEMUX_ERROR,t,i,n,"MEDIA_ERR_DECODE")}},{key:"_handleAddRAP",value:function(e){this.state.randomAccessPoints&&this.state.randomAccessPoints.push(e)}},{key:"_onError",value:function(e,t,i,n,r){var a="["+t+"]: "+i.message,o={errorType:e,errorDetails:a,errorFatal:n||!1};this._player.emit("FLV_ERROR",o),this._player.video&&this._player.video.handleErr(r,a)}},{key:"_isHEVC",value:function(e){return e&&"hev1.1.6.L93.B0"===e.codec}},{key:"seek",value:function(){this.state.initSegmentArrived||this.loadData()}},{key:"loadData",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._player.config.url;this.emit(Xt.LADER_START,e)}},{key:"pause",value:function(){var e=this._context.getInstance("FETCH_LOADER");e&&e.cancel()}},{key:"destroy",value:function(){this.state.randomAccessPoints=[]}}]),t}(),Kt=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();var Yt=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return Kt(e,[{key:"warn",value:function(){}}]),e}(),qt={FlvDemuxer:ht,FetchLoader:ue,Tracks:T,XgBuffer:O,Logger:Yt},Zt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Jt=function e(t,i,n){null===t&&(t=Function.prototype);var r=Object.getOwnPropertyDescriptor(t,i);if(void 0===r){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,i,n)}if("value"in r)return r.value;var o=r.get;return void 0!==o?o.call(n):void 0},Qt=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();var $t=d.FlvAllowedEvents,ei=function(t){function i(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,i),e.mediaType||(e.mediaType="live-video",e.videoConfig?e.videoConfig.preloadtime=e.preloadTime||5:e.videoConfig={preloadtime:e.preloadTime||5});var t=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==(void 0===t?"undefined":Zt(t))&&"function"!=typeof t?e:t}(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e));return t.config=Object.assign({},qt,t.config),t.playerInited||t.initPlayer(e),t}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":Zt(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(i,t),Qt(i,null,[{key:"isSupported",value:function(){var e="WebAssembly"in window,t=!1;return"customElements"in window&&window.customElements.define&&(t=window.customElements.get("live-video")),e&&t}}]),Qt(i,[{key:"initPlayer",value:function(){this.video.width=Number.parseInt(this.config.width||600),this.video.height=Number.parseInt(this.config.height||337.5),this.video.style.outline="none",this.context=new q($t),this.playerInited=!0}},{key:"start",value:function(){this.playerInited||this.initPlayer(),this.initFlv(),this.context.init(),this.flv.seek(0),Jt(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"start",this).call(this,this.config.url)}},{key:"initFlvEvents",value:function(e){var t=this;e.once(d.LOADER_EVENTS.LOADER_COMPLETE,(function(){if(!t.paused)var e=setInterval((function(){var i=t.getBufferedRange()[1];Math.abs(t.currentTime-i)<.5&&(t.video&&t.video.handleEnded(),window.clearInterval(e))}),200)}))}},{key:"initFlv",value:function(){var e=this.context.registry("FLV_CONTROLLER",Wt)(this);this.initFlvEvents(e),this.flv=e}},{key:"play",value:function(){if(this._hasStart&&this.paused){this._destroy(),this.context=new q($t);var e=this.context.registry("FLV_CONTROLLER",Wt)(this);this.initFlvEvents(e),this.flv=e,this.context.init(),this.loadData(),Jt(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"start",this).call(this),Jt(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"play",this).call(this)}else Jt(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"play",this).call(this),this.addLiveFlag()}},{key:"pause",value:function(){Jt(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"pause",this).call(this),this.flv&&this.flv.pause()}},{key:"loadData",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.currentTime;this.flv&&this.flv.seek(e)}},{key:"destroy",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._destroy();var t=this.video,n=this.root;Jt(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"destroy",this).call(this,e),t&&t.remove?t.remove():n&&n.removeChild(t)}},{key:"addLiveFlag",value:function(){if(e.util.addClass(this.root,"xgplayer-is-live"),!e.util.findDom(this.root,"xg-live")){var t=e.util.createDom("xg-live","正在直播",{},"xgplayer-live");this.controls.appendChild(t)}}},{key:"_destroy",value:function(){this.context.destroy(),this.flv=null,this.context=null}},{key:"src",get:function(){return this.currentSrc},set:function(e){this.config.url=e,this.paused?this.start(e):(this.currentTime=0,this.pause(),this.play())}}]),i}(e),ti=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();var ii=function(){function t(i){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),ei.isSupported()&&i.useWASM?new ei(i):Gt.isSupported()?new Gt(i):new e(i)}return ti(t,null,[{key:"install",value:function(t,i){return e.install(t,i)}}]),t}();ii.EVENTS=d;var ni=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();function ri(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var ai=d.REMUX_EVENTS,oi=d.DEMUX_EVENTS,si=d.LOADER_EVENTS,ui=d.MSE_EVENTS,li=function(){function e(){ri(this,e)}return ni(e,[{key:"warn",value:function(){}}]),e}(),ci=function(){function t(e,i){ri(this,t),this.TAG="FLVController",this.mse=i,this.state={initSegmentArrived:!1,range:{start:0,end:""},rangeSupport:!0}}return ni(t,[{key:"init",value:function(){this._context.registry("FETCH_LOADER",ue),this._context.registry("LOADER_BUFFER",O),this._context.registry("FLV_DEMUXER",ht),this._context.registry("TRACKS",T),this._context.registry("MP4_REMUXER",Tt)(this._player.currentTime),this._context.registry("PRE_SOURCE_BUFFER",_),this._context.registry("COMPATIBILITY",Ve),this._context.registry("LOGGER",li),this.mse||(this.mse=new $({container:this._player.video},this._context),this.mse.init()),this.initListeners()}},{key:"initListeners",value:function(){this.on(si.LOADER_DATALOADED,this._handleLoaderDataLoaded.bind(this)),this.on(si.LOADER_ERROR,this._handleNetworkError.bind(this)),this.on(oi.MEDIA_INFO,this._handleMediaInfo.bind(this)),this.on(oi.METADATA_PARSED,this._handleMetadataParsed.bind(this)),this.on(oi.DEMUX_COMPLETE,this._handleDemuxComplete.bind(this)),this.on(oi.DEMUX_ERROR,this._handleDemuxError.bind(this)),this.on(oi.SEI_PARSED,this._handleSEIParsed.bind(this)),this.on(ui.MSE_ERROR,this._handleMseError.bind(this)),this.on(ai.INIT_SEGMENT,this._handleAppendInitSegment.bind(this)),this.on(ai.MEDIA_SEGMENT,this._handleMediaSegment.bind(this))}},{key:"_handleMediaInfo",value:function(){var e=this;this._context.onMetaData||this.emit(oi.DEMUX_ERROR,new Error("failed to get mediainfo"));var t=this._context.getInstance("LOADER_BUFFER"),i=this._context.getInstance("FETCH_LOADER");this.isSeekable&&(i.cancel(),this.state.range={start:0,end:t.historyLen-1},setTimeout((function(){e.loadNext(0)})))}},{key:"_handleLoaderDataLoaded",value:function(){this.emitTo("FLV_DEMUXER",oi.DEMUX_START)}},{key:"_handleMetadataParsed",value:function(e){this.emit(ai.REMUX_METADATA,e)}},{key:"_handleSEIParsed",value:function(e){this._player.emit("SEI_PARSED",e)}},{key:"_handleDemuxComplete",value:function(){this.emit(ai.REMUX_MEDIA,"flv")}},{key:"_handleAppendInitSegment",value:function(){this.state.initSegmentArrived=!0,this.mse.addSourceBuffers()}},{key:"_handleMediaSegment",value:function(){this.mse.addSourceBuffers(),this.mse.doAppend()}},{key:"_handleNetworkError",value:function(t,i){this._player.emit("error",new e.Errors("network",this._player.config.url)),this._onError(si.LOADER_ERROR,t,i,!0)}},{key:"_handleDemuxError",value:function(t,i,n){void 0===n&&(n=!1),this._player.emit("error",new e.Errors("parse",this._player.config.url)),this._onError(si.LOADER_ERROR,t,i,n)}},{key:"_handleMseError",value:function(e,t,i){void 0===i&&(i=!1),this._onError(ui.MSE_ERROR,e,t,i)}},{key:"_onError",value:function(e,t,i,n){var r={errorType:e,errorDetails:"["+t+"]: "+(i?i.message:""),errorFatal:n||!1};this._player.emit("FLV_ERROR",r)}},{key:"seek",value:function(e){if(this._context.onMetaData){if(this.isSeekable){this._context.getInstance("LOADER_BUFFER").clear();var t=this._player.config.preloadTime,i=void 0===t?15:t,n=this.getSeekRange(e,i);this.state.range=n,this.compat&&this.compat.reset(),this.loader.destroy(),this._context.registry("FETCH_LOADER",ue)(),this.loadData()}}else this.loadMeta()}},{key:"loadNext",value:function(e){this._context.onMetaData&&(this.loader.loading||this.getNextRange(e)&&this.loadData())}},{key:"loadData",value:function(){var e=this.state.range,t=e.start,i=e.end;this.emit(si.LADER_START,this._player.config.url,{headers:{method:"get",Range:"bytes="+t+"-"+i}})}},{key:"loadMeta",value:function(){var e=this;this.loader.load(this._player.config.url,{headers:{Range:"bytes=0-"}}).catch((function(){e.state.rangeSupport=!1,e.loadFallback()}))}},{key:"loadFallback",value:function(){var t=this;this.loader.load(this._player.config.url).catch((function(){t._player.emit("error",new e.Errors("network",t._player.config.url))}))}},{key:"getSeekRange",value:function(e,i){var n=this._context.onMetaData.keyframes,r=this._context.mediaInfo.duration,a=e,o=e+i,s=t.findFilePosition(a,n);return o>=r||a>=r?{start:s,end:""}:{start:s,end:t.findFilePosition(o,n)}}},{key:"getNextRange",value:function(e){if(""!==this.state.range.end){var t=this.getSeekRange(e,this.config.preloadTime||15).end;if(!(t<=this.state.range.end&&""!==t))return this.state.range={start:this.state.range.end+1,end:t},!0}}},{key:"destroy",value:function(){this.mse=null,this.state={initSegmentArrived:!1,range:{start:0,end:""},rangeSupport:!0}}},{key:"isSeekable",get:function(){return!(!this.state.rangeSupport||!this._context)&&(null!==this._context.onMetaData.keyframes&&void 0!==this._context.onMetaData.keyframes)}},{key:"config",get:function(){return this._player.config}},{key:"loader",get:function(){return this._context.getInstance("FETCH_LOADER")}},{key:"compat",get:function(){return this._context.getInstance("COMPATIBILITY")}},{key:"loadBuffer",get:function(){return this._context.getInstance("LOADER_BUFFER")}}],[{key:"findFilePosition",value:function(e,t){for(var i=0,n=t.times.length;i<n;i++){var r=t.times[i],a=i+1<n?t.times[i+1]:Number.MAX_SAFE_INTEGER;if(r<=e&&e<=a)return t.filepositions[i]}return""}}]),t}(),hi="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},fi=function e(t,i,n){null===t&&(t=Function.prototype);var r=Object.getOwnPropertyDescriptor(t,i);if(void 0===r){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,i,n)}if("value"in r)return r.value;var o=r.get;return void 0!==o?o.call(n):void 0},di=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();var pi=function(e,t){var i=Date.now(),n=null,r=!0;return function(){for(var a=arguments.length,o=Array(a),s=0;s<a;s++)o[s]=arguments[s];var u=Date.now();r&&(i=Date.now(),r=!1,e.apply(void 0,o)),u-i>t?(i=u,e.apply(void 0,o)):(n&&window.clearTimeout(n),n=setTimeout((function(){e.apply(void 0,o)}),t))}},vi=d.FlvAllowedEvents,yi=function(t){function i(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,i);var t=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==(void 0===t?"undefined":hi(t))&&"function"!=typeof t?e:t}(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e));return t.initEvents(),t}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":hi(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(i,t),di(i,null,[{key:"isSupported",value:function(){return window.MediaSource&&window.MediaSource.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"')}},{key:"install",value:function(t,i){return e.install(t,i)}}]),di(i,[{key:"start",value:function(){if(!this.started){this.context||(this.context=new q(this,this.config,vi));var e=this.initFlv();e.loadMeta(),fi(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"start",this).call(this,e.mse.url),this.started=!0}}},{key:"initFlv",value:function(){var e=this.context.registry("FLV_CONTROLLER",ci)(this);return this.context.init(),this.flv=e,this.mse=e.mse,e}},{key:"initFlvBackupEvents",value:function(e,t){var i=this;e.once(d.REMUX_EVENTS.INIT_SEGMENT,(function(){var n=3;e.on(d.REMUX_EVENTS.MEDIA_SEGMENT,(function(){0===(n-=1)&&(i.flv=e,i.mse.resetContext(t),i.context.destroy(),i.context=t)}))})),e.once(d.LOADER_EVENTS.LOADER_ERROR,(function(){t.destroy()}))}},{key:"initEvents",value:function(){this.on("timeupdate",this.handleTimeUpdate.bind(this)),this.on("seeking",this.handleSeek.bind(this)),this.once("destroy",this._destroy.bind(this))}},{key:"handleTimeUpdate",value:function(){this.loadData(),function(e,t){if(!e.config.isLive&&e.duration-e.currentTime<2){var i=e.getBufferedRange();e.currentTime-i[1]<.1&&(e.emit("ended"),t.mse.endOfStream())}}(this,this.flv)}},{key:"handleSeek",value:function(){var e=this.currentTime,t=this.getBufferedRange();(e>t[1]||e<t[0])&&pi(this.flv.seek(this.currentTime),200)}},{key:"_destroy",value:function(){this.context&&this.context.destroy(),this.context=null,this.flv=null}},{key:"loadData",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.currentTime,t=this.getBufferedRange();t[1]-e<(this.config.preloadTime||15)-5&&this.flv.loadNext(t[1]+1)}},{key:"switchURL",value:function(e){this.config.url=e;var t=new q(this,this.config,vi),i=t.registry("FLV_CONTROLLER",ci)(this,this.mse);this.newContext=t,this.newFlv=i,t.init(),t.getInstance("MP4_REMUXER")._dtsBase=0,this.initFlvBackupEvents(i,t),i.loadMeta()}},{key:"remuxer",get:function(){return this.context.getInstance("MP4_REMUXER")}},{key:"src",get:function(){return this.currentSrc},set:function(e){return this.switchURL(e)}}]),i}(e),_i=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();return function(){function t(e){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),e.isLive?new ii(e):new yi(e)}return _i(t,null,[{key:"isSupported",value:function(){return window.MediaSource&&window.MediaSource.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"')}},{key:"install",value:function(t,i){return e.install(t,i)}}]),t}()}));
//# sourceMappingURL=index.min.js.map
